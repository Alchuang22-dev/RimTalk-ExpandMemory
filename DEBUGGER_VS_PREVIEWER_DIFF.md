# ?? RimTalk调试界面 vs 预览器差异说明

## ? 用户问题

> "在rimtalk调试界面中显示注入的记忆和常识和调试预览器中显示的不一样，哪边是对的？"

---

## ? **答案：两边都是对的，但查看的是不同场景**

---

## ?? 核心差异说明

### 1?? **ExpandMemory调试预览器** (`Dialog_InjectionPreview`)

**查看的场景**：模拟对话**开始前**的注入状态

```csharp
// 调用方式：使用空上下文或用户输入的测试上下文
DynamicMemoryInjection.InjectMemoriesWithDetails(
    memoryComp, 
    contextInput,  // 用户在预览器中输入的测试上下文（可为空）
    maxMemories,
    out scores
);
```

**特点**：
- ? **可控上下文**：用户可以输入任意测试上下文，观察不同场景下的注入结果
- ? **纯净评分**：留空时基于重要性和层级加成，不受对话内容干扰
- ? **调试友好**：可以反复测试不同上下文对注入结果的影响
- ? **v2.4.3新增**：支持输入上下文，完全模拟实际对话场景

---

### 2?? **RimTalk调试界面** (`DebugWindow`)

**查看的场景**：实际对话**发生时**的注入状态

```csharp
// RimTalk调用流程：
public static string GetMemoryPrompt(Pawn pawn, string basePrompt)
{
    // basePrompt = 用户实际输入的完整对话内容
    memoryContext = DynamicMemoryInjection.InjectMemories(
        pawn, 
        basePrompt,  // ?? 实际对话内容作为上下文
        maxMemories
    );
    
    // 构建完整的system + user prompt
    return BuildFullPrompt(memoryContext, knowledgeContext, basePrompt);
}
```

**特点**：
- ? **实际场景**：显示真实对话中AI接收到的注入内容
- ? **上下文相关**：评分会根据对话内容中的关键词动态调整
- ? **可能变化**：同一条记忆在不同对话场景下可能评分不同

---

## ?? 为什么会显示不一样？

### **原因：上下文影响评分**

动态注入系统的评分公式：

```
总评分 = 重要性(30%) + 关键词匹配(40%) + 时间衰减(30%) + 层级加成 + 特殊加成
```

**关键词匹配** 这一项会根据上下文变化！

### ?? 举例说明

假设有两条记忆：
1. **记忆A**："Alice今天烹饪了美味的食物" (重要性0.8)
2. **记忆B**："Alice和Bob讨论了防御工事" (重要性0.6)

#### 场景1：预览器（空上下文）
```
上下文输入：（空）

评分结果：
- 记忆A：0.32 (重要性0.8 × 0.3 + 层级0.7 × 0.2 + 关键词0)
- 记忆B：0.26 (重要性0.6 × 0.3 + 层级0.7 × 0.2 + 关键词0)

结果：记忆A排名第1 ?
```

#### 场景2：实际对话（包含"防御"关键词）
```
用户输入："我们需要加强防御吗？"
上下文：包含"防御"关键词

评分结果：
- 记忆A：0.32 (无关键词匹配)
- 记忆B：0.66 (重要性0.6 × 0.3 + 层级0.7 × 0.2 + 关键词0.4 × 0.4)

结果：记忆B排名第1 ?（因为关键词"防御"匹配！）
```

**这是设计特性，不是bug！**

---

## ?? v2.4.3改进：预览器支持上下文输入

现在预览器新增了**上下文输入框**，你可以：

1. **留空**：查看纯净评分（仅基于重要性和层级）
2. **输入测试文本**：模拟不同对话场景，查看评分变化

### 使用方法

```
1. 打开预览器
2. 选择殖民者
3. 在"上下文输入"框中输入测试文本（例如："防御"、"食物"等）
4. 点击"刷新预览"
5. 观察记忆评分和选择的变化
```

---

## ?? 最佳实践建议

### 对于用户：
1. **使用预览器测试**：输入不同上下文，了解哪些记忆会被触发
2. **调整阈值**：如果某些记忆总是被过滤，降低`memoryScoreThreshold`
3. **固定重要记忆**：在主UI中固定记忆，确保它们总是被注入

### 对于调试：
1. **预览器** → 查看纯净评分，调整重要性和层级设置
2. **RimTalk调试界面** → 查看实际对话中的注入效果
3. **对比两者** → 理解关键词匹配的影响

---

## ?? 总结表

| 特性 | 预览器 | RimTalk调试界面 |
|------|--------|----------------|
| **上下文来源** | 用户输入（可为空）| 实际对话内容 |
| **评分方式** | 可控测试 | 实际评分 |
| **用途** | 调试、测试、优化 | 验证实际效果 |
| **是否正确** | ? 正确（测试场景） | ? 正确（实际场景）|
| **推荐使用** | 开发调试、设置优化 | 验证实际对话效果 |

---

## ?? 关键要点

1. ? **两边都是对的**，查看的是不同场景
2. ? **评分会随上下文变化**，这是动态注入的核心特性
3. ? **v2.4.3改进**：预览器支持输入上下文，完全模拟实际场景
4. ? **如需一致**：在预览器中输入与实际对话相同的文本即可

---

## ?? 更新日志

### v2.4.3 (2025-01-XX)
- ? 预览器新增上下文输入框
- ? 支持模拟不同对话场景
- ? 显示上下文状态和使用方式
- ?? 添加本说明文档

---

**结论**：两边显示不同是正常的，因为它们模拟的是不同场景。使用预览器的上下文输入功能，你可以完全重现RimTalk调试界面中看到的结果！
