# 常识库注入顺序优化 - 覆盖RimTalk提示词

## ?? 更新概览

**版本**: v2.3.1  
**日期**: 2024-01-XX  
**改动**: 调整常识库注入顺序，使其位于system message最上方

---

## ? 核心改动

### 注入顺序调整

#### 旧顺序
```
RimTalk内置提示词
↓
【记忆】
↓
【常识】
```

#### 新顺序 ?
```
【常识】          ← 优先级最高，可以覆盖RimTalk
↓
RimTalk内置提示词
↓
【记忆】          ← 提供上下文
```

### 优先级说明

```
┌─────────────────────────────────────┐
│  【常识】- 优先级: ★★★★★          │  ← 最高优先级
│  用途: 覆盖/修正RimTalk内置设定   │
│  示例: [规则] 回复控制在80字以内  │
└─────────────────────────────────────┘
             ↓ 可以覆盖
┌─────────────────────────────────────┐
│  RimTalk内置提示词 - 优先级: ★★★  │
│  可能包含bug或不理想的设定        │
└─────────────────────────────────────┘
             ↓ 可以覆盖
┌─────────────────────────────────────┐
│  【记忆】- 优先级: ★              │  ← 最低优先级
│  用途: 提供对话上下文             │
└─────────────────────────────────────┘
```

---

## ?? 为什么这样做？

### 问题背景

RimTalk的内置提示词可能存在：
- ? 回复过长，浪费Token
- ? 语言风格重复，词汇单一
- ? 角色性格不一致
- ? 游戏知识错误
- ? 偶尔跳出角色
- ? 其他不理想的行为

### 解决方案

通过将**常识库放在最上方**，用户可以：
- ? 添加自定义规则覆盖RimTalk的默认设定
- ? 修复已知的bug或问题
- ? 强制执行字数限制、风格约束等
- ? 补充或修正游戏知识
- ? 完全掌控AI的行为

---

## ?? 实用案例

### 案例1: 修复回复过长

**常识库添加**:
```
[规则] 所有回复必须简洁，控制在80字以内
[规则] 只回答用户的具体问题，不要主动延伸
```

**效果**:
- 原本: 200字的冗长回复
- 现在: 80字的简洁回复
- 节省: 60% Token

---

### 案例2: 修复重复用词

**常识库添加**:
```
[规则] 避免重复使用相同的词汇和句式
[禁止] 禁止在同一回复中多次使用"确实"、"的确"
```

**效果**:
- 原本: "确实，这确实是个问题，确实需要解决"
- 现在: "是的，这个问题需要尽快解决"
- 改善: 语言更自然，不重复

---

### 案例3: 强制角色性格

**常识库添加**:
```
[角色] Alice性格谨慎保守，说话前会三思
[规则] Alice回复时应多用"可能"、"也许"等词
[风格] Alice不会使用夸张或激进的表达
```

**效果**:
- 原本: "我肯定能做到！这太简单了！"
- 现在: "我可能能做到，需要仔细规划一下"
- 改善: 符合角色性格

---

### 案例4: 修复跳出角色

**常识库添加**:
```
[规则] 你永远是殖民者本人，不是AI助手
[禁止] 禁止提及"作为AI"、"我是语言模型"
[规则] 始终从角色第一人称视角回答
```

**效果**:
- 原本: "作为AI，我无法真正体验..."
- 现在: "我当时感到非常紧张..."
- 改善: 保持沉浸感

---

## ?? 技术实现

### 代码修改

**文件**: `Source\Memory\UI\Dialog_InjectionPreview.cs`

**旧代码**:
```csharp
systemContent.AppendLine("你是一个RimWorld殖民地的角色扮演AI。");
systemContent.AppendLine($"你正在扮演 {selectedPawn.LabelShort}。");

if (!string.IsNullOrEmpty(memoryInjection))
{
    systemContent.AppendLine("【记忆】");
    systemContent.AppendLine(memoryInjection);
}

if (!string.IsNullOrEmpty(knowledgeInjection))
{
    systemContent.AppendLine("【常识】");
    systemContent.AppendLine(knowledgeInjection);
}
```

**新代码**:
```csharp
// 【优先级1: 常识库】- 最上方，可以覆盖RimTalk
if (!string.IsNullOrEmpty(knowledgeInjection))
{
    systemContent.AppendLine("【常识】");
    systemContent.AppendLine(knowledgeInjection);
    systemContent.AppendLine();
}

// 【优先级2: RimTalk内置提示词】- 中间
systemContent.AppendLine("你是一个RimWorld殖民地的角色扮演AI。");
systemContent.AppendLine($"你正在扮演 {selectedPawn.LabelShort}。");
systemContent.AppendLine();

// 【优先级3: 记忆】- 最后，提供上下文
if (!string.IsNullOrEmpty(memoryInjection))
{
    systemContent.AppendLine("【记忆】");
    systemContent.AppendLine(memoryInjection);
}
```

---

## ?? 使用指南

### 1. 添加全局规则

在常识库管理器中添加：
```
[规则] 回复控制在80字以内
[规则] 避免重复词汇
[规则] 保持角色扮演
```

### 2. 修复已知Bug

发现RimTalk的问题后：
```
[修复] RimTalk总是用"确实"
[禁止] 禁止重复使用"确实"、"的确"
```

### 3. 设置角色性格

为每个殖民者定制：
```
[角色] Alice谨慎保守
[风格] 多用"可能"、"也许"
[禁止] 不使用夸张表达
```

### 4. 补充游戏知识

修正机制错误：
```
[规则] 钢铁墙壁无法防御穿甲弹
[规则] 太阳能板夜间无效
```

### 5. 测试验证

使用调试预览器：
1. 打开 Mod设置 → RimTalk-ExpandMemory
2. 点击 "打开调试预览器"
3. 选择殖民者
4. 查看注入顺序和效果

---

## ?? 最佳实践

### ? 推荐做法

1. **设置5-10条核心规则**
   - 字数限制
   - 风格约束
   - 角色性格
   
2. **使用明确的标签**
   - `[规则]` - 必须遵守的规则
   - `[禁止]` - 禁止的行为
   - `[角色]` - 角色设定
   - `[风格]` - 语言风格

3. **重要性设置**
   - 核心规则: 0.9-1.0
   - 角色设定: 0.7-0.9
   - 补充信息: 0.5-0.7

### ? 不推荐做法

1. **不要在常识库中描述具体事件**
   - ? `[事件] Alice昨天建造了墙壁`
   - ? 这是记忆的职责

2. **不要写临时性信息**
   - ? `[规则] 今天天气很好`
   - ? 常识应该是长期有效的

3. **不要过度使用**
   - ? 添加100条常识
   - ? 5-10条核心规则即可

---

## ?? 效果对比

### 场景: 用户问"你能做什么？"

#### 未使用常识库覆盖
```
回复: "当然可以！我可以做很多事情！确实，我擅长建造，
      确实也会烹饪，而且确实在研究方面也有涉猎。殖民地
      的很多工作都是我负责的，确实非常忙碌，但确实也很
      充实。你有什么需要帮助的吗？我确实可以..." (140字)

问题:
- ? 太长 (140字)
- ? 重复用词 ("确实"出现6次)
- ? 主动延伸话题
```

#### 使用常识库覆盖后
```
常识库规则:
[规则] 回复控制在80字以内，简洁明了
[规则] 避免重复使用相同词汇
[规则] 只回答用户问题，不主动延伸

回复: "我擅长建造和烹饪，最近也在研究新技术。
      墙壁、防御工事这些都是我负责的。" (42字)

改善:
- ? 简洁 (42字，节省70% Token)
- ? 无重复词汇
- ? 只回答问题
```

---

## ?? 总结

### 核心优势

1. **可编程的提示词** - 常识库成为可编程的覆盖层
2. **完全掌控** - 用户可以修复任何RimTalk的问题
3. **灵活调整** - 随时添加/修改规则，无需等待RimTalk更新
4. **提高质量** - 输出更符合预期，更有针对性
5. **降低成本** - 通过字数限制等规则节省Token

### 使用建议

```
第1步: 添加基础规则 (字数、风格、角色)
第2步: 使用调试预览器测试效果
第3步: 根据实际使用调整规则
第4步: 固化有效的规则作为模板
第5步: 针对不同殖民者定制规则
```

---

## ?? 更新日志

**v2.3.1** (当前版本)
- ? 常识库注入顺序调整到最上方
- ? 可以覆盖RimTalk内置提示词
- ?? 添加详细的使用案例和最佳实践
- ?? 更新调试预览器说明

---

**常识库 = 可编程的提示词覆盖层，让您完全掌控AI！** ??

使用调试预览器查看实际注入效果：
Mod设置 → RimTalk-ExpandMemory → 打开调试预览器
