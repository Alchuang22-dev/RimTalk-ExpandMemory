# 常识库角色关键词增强 - 修复婴儿等角色常识不注入的问题

## ?? 问题描述

**用户反馈**:
```
我设置常识: "婴儿不会说话"
关键词: ["婴儿"]
重要性: 0.8

但是对婴儿说话或选择婴儿角色时，这条常识都不会被注入！
```

## ?? 根本原因

### 旧的匹配机制

之前的常识库只从**context文本**中提取关键词进行匹配：

```csharp
// 旧代码
List<string> contextKeywords = ExtractKeywords(context);
// context = 用户输入的对话内容

// 问题:
// 1. 如果用户说"你好吗？"，不包含"婴儿"这个词
// 2. 当前说话的角色是婴儿，但没有被考虑
// 3. 导致常识库无法匹配到"婴儿不会说话"这条规则
```

### 缺失的信息

- ? 没有考虑**当前说话的角色**
- ? 没有考虑**角色的年龄段**（婴儿/儿童/青少年/成人）
- ? 没有考虑**角色的特质**和**性别**
- ? 只依赖用户输入的文本，信息不完整

---

## ? 解决方案

### 增强的关键词提取系统

现在的常识库会**自动提取角色相关的关键词**：

```csharp
// 新代码
public string InjectKnowledgeWithDetails(
    string context, 
    int maxEntries, 
    out List<KnowledgeScore> scores, 
    Verse.Pawn currentPawn = null  // ? 新增参数
)
{
    // 1. 提取上下文关键词
    List<string> contextKeywords = ExtractContextKeywords(context);
    
    // 2. 添加角色关键词 ? 关键改进
    if (currentPawn != null)
    {
        AddPawnKeywords(contextKeywords, currentPawn);
    }
    
    // 3. 基于增强后的关键词进行匹配
    ...
}
```

---

## ?? 自动提取的角色关键词

### 1. 角色名字
```csharp
keywords.Add(pawn.Name.ToStringShort);
// 例如: "小明", "Alice", "Bob"
```

### 2. 年龄段标签 ? **最关键**
```csharp
if (ageYears < 3f)
{
    keywords.Add("婴儿");
    keywords.Add("宝宝");
    keywords.Add("小宝");
    keywords.Add("baby");
}
else if (ageYears < 13f)
{
    keywords.Add("儿童");
    keywords.Add("小孩");
    keywords.Add("孩子");
    keywords.Add("child");
}
else if (ageYears < 18f)
{
    keywords.Add("青少年");
    keywords.Add("teenager");
}
else
{
    keywords.Add("成人");
    keywords.Add("adult");
}
```

### 3. 性别
```csharp
keywords.Add(pawn.gender.GetLabel());
// 例如: "男性", "女性"
```

### 4. 角色类型
```csharp
keywords.Add(pawn.def.label);
// 例如: "人类", "机械体"
```

### 5. 主要特质
```csharp
foreach (var trait in pawn.story.traits.allTraits)
{
    keywords.Add(trait.def.label);
}
// 例如: "勤劳", "细心", "夜猫子"
```

---

## ?? 实际效果对比

### 场景1: 对婴儿说话

**旧系统**:
```
用户输入: "你好吗？"
提取关键词: ["你好", "好吗"]
常识库: [婴儿] "婴儿不会说话" (关键词: ["婴儿"])
匹配结果: ? 不匹配 (评分0.0)
```

**新系统**:
```
用户输入: "你好吗？"
提取关键词: ["你好", "好吗"]
+ 角色关键词: ["小宝", "婴儿", "宝宝", "小宝", "baby", "男性", "人类"]
常识库: [婴儿] "婴儿不会说话" (关键词: ["婴儿"])
匹配结果: ? 匹配！(评分0.72)
```

---

### 场景2: 婴儿自己说话

**旧系统**:
```
当前角色: 婴儿（0.5岁）
上下文: ""
提取关键词: []
常识库: [婴儿] "婴儿不会说话"
匹配结果: ? 不匹配 (评分0.0)
```

**新系统**:
```
当前角色: 婴儿（0.5岁）
上下文: ""
提取关键词: []
+ 角色关键词: ["小宝", "婴儿", "宝宝", "小宝", "baby", "男性", "人类"]
常识库: [婴儿] "婴儿不会说话"
匹配结果: ? 匹配！(评分0.80)
```

---

### 场景3: 针对特质的常识

**常识设置**:
```
[规则] 勤劳的人说话简洁高效，不废话
关键词: ["勤劳"]
```

**旧系统**:
```
角色特质: 勤劳
用户输入: "你在做什么？"
提取关键词: ["你在", "在做", "做什么", "什么"]
匹配结果: ? 不匹配 (没有"勤劳")
```

**新系统**:
```
角色特质: 勤劳
用户输入: "你在做什么？"
提取关键词: ["你在", "在做", "做什么", "什么"]
+ 角色关键词: ["Alice", "成人", "女性", "人类", "勤劳", "细心"]
匹配结果: ? 匹配！(评分0.65)
```

---

## ?? 使用指南

### 1. 设置年龄段相关的常识

```
[规则] 婴儿不会说话，只能咿呀学语
关键词: 婴儿

[规则] 儿童说话简单直接，用词简单
关键词: 儿童, 小孩

[规则] 青少年容易叛逆，说话带刺
关键词: 青少年

[规则] 成人说话成熟稳重，考虑周全
关键词: 成人
```

**效果**: 系统会自动根据角色年龄匹配对应的常识！

---

### 2. 设置特质相关的常识

```
[风格] 勤劳的人说话简洁高效
关键词: 勤劳

[风格] 懒惰的人说话拖沓敷衍
关键词: 懒惰

[性格] 细心的人回复时会注意细节
关键词: 细心

[性格] 粗心的人容易忽略重要信息
关键词: 粗心
```

**效果**: 系统会自动根据角色特质匹配对应的风格！

---

### 3. 设置性别相关的常识

```
[规则] 男性角色语气更直接
关键词: 男性

[规则] 女性角色语气更委婉
关键词: 女性
```

**效果**: 系统会自动根据角色性别调整语言风格！

---

## ?? 评分计算示例

### 示例: 婴儿说话场景

**常识库条目**:
```
标签: [规则]
内容: "婴儿不会说话，只能发出咿呀声"
关键词: ["婴儿", "不会", "会说", "说话"]
重要性: 0.9
```

**当前情况**:
```
角色: 小宝（0.5岁婴儿）
用户输入: "你好吗？"
```

**关键词提取**:
```
上下文关键词: ["你好", "好吗"]
角色关键词: ["小宝", "婴儿", "宝宝", "小宝", "baby", "男性", "人类"]
合并后: ["你好", "好吗", "小宝", "婴儿", "宝宝", "baby", "男性", "人类"]
```

**Jaccard相似度计算**:
```
常识关键词: ["婴儿", "不会", "会说", "说话"]
上下文关键词: ["你好", "好吗", "小宝", "婴儿", "宝宝", "baby", "男性", "人类"]

交集: ["婴儿"]  → 1个
并集: ["婴儿", "不会", "会说", "说话", "你好", "好吗", "小宝", "宝宝", "baby", "男性", "人类"]  → 11个

Jaccard = 1 / 11 = 0.091
```

**最终评分**:
```
Score = (JaccardSimilarity * 0.7 + TagMatch * 0.3) * Importance
      = (0.091 * 0.7 + 0 * 0.3) * 0.9
      = 0.064 * 0.9
      = 0.0576
```

?? **注意**: 这个分数可能低于默认阈值0.10！

### ?? 如何提高匹配率

#### 方法1: 调整关键词
```
// 原来
关键词: ["婴儿", "不会", "会说", "说话"]

// 优化后 - 只保留核心关键词
关键词: ["婴儿"]
```

**新评分**:
```
交集: ["婴儿"]  → 1个
并集: ["婴儿", "你好", "好吗", "小宝", "宝宝", "baby", "男性", "人类"]  → 8个

Jaccard = 1 / 8 = 0.125
Score = (0.125 * 0.7) * 0.9 = 0.079
```
还是低于0.10！

#### 方法2: 提高重要性
```
重要性: 0.9 → 1.0
```

**新评分**:
```
Score = (0.125 * 0.7) * 1.0 = 0.088
```
还是低于0.10！

#### 方法3: 降低阈值 ? **推荐**
```
Mod设置:
常识阈值: 0.10 → 0.05
```

**效果**: 所有评分>0.05的常识都会被注入！

#### 方法4: 添加同义词
```
关键词: ["婴儿", "宝宝", "baby"]
```

**新评分**:
```
交集: ["婴儿", "宝宝", "baby"]  → 3个
并集: ["婴儿", "宝宝", "baby", "你好", "好吗", "小宝", "男性", "人类"]  → 8个

Jaccard = 3 / 8 = 0.375
Score = (0.375 * 0.7) * 0.9 = 0.236
```
? **高于阈值0.10，会被注入！**

---

## ?? 推荐配置

### 针对年龄段常识

```
[规则] 婴儿不会说话，只能发出咿呀声
关键词: 婴儿, 宝宝, baby
重要性: 1.0

[规则] 儿童说话简单直接，用词简单
关键词: 儿童, 小孩, 孩子, child
重要性: 0.9

[规则] 青少年容易叛逆，说话带刺
关键词: 青少年, teenager
重要性: 0.8

[规则] 成人说话成熟稳重
关键词: 成人, adult
重要性: 0.8
```

**Mod设置**:
```
常识阈值: 0.05 (降低阈值，确保年龄段常识能匹配)
最大常识: 5-10
```

---

## ?? 测试验证

### 开启开发模式查看日志

1. 游戏设置 → 开启开发模式
2. 对婴儿说话
3. 查看日志:

```
[Knowledge] Added pawn keywords: 小宝, 婴儿, 宝宝, 小宝, baby, 男性, 人类
[Knowledge Injection] Knowledge entry matched: [规则] 婴儿不会说话 (Score: 0.236)
```

### 使用调试预览器

1. Mod设置 → RimTalk-ExpandMemory
2. 点击 "打开调试预览器"
3. 选择婴儿角色
4. 查看"常识库注入详细分析"部分
5. 确认"婴儿不会说话"这条常识是否被注入

---

## ?? 代码改动摘要

### 1. CommonKnowledgeLibrary.cs

**新增方法**:
```csharp
// 添加角色关键词到上下文
private void AddPawnKeywords(List<string> keywords, Verse.Pawn pawn)

// 获取年龄段标签
private string GetAgeLabel(Verse.Pawn pawn)
```

**修改方法**:
```csharp
// 新增 currentPawn 参数
public string InjectKnowledgeWithDetails(
    string context, 
    int maxEntries, 
    out List<KnowledgeScore> scores, 
    Verse.Pawn currentPawn = null  // ? 新增
)
```

### 2. RimTalkPrecisePatcher.cs

**更新调用**:
```csharp
// 传递 mainPawn 给常识库
string knowledgeContext = memoryManager.CommonKnowledge.InjectKnowledgeWithDetails(
    __result,
    RimTalkMemoryPatchMod.Settings.maxInjectedKnowledge,
    out _,
    mainPawn  // ? 传递当前Pawn
);
```

### 3. Dialog_InjectionPreview.cs

**更新调用**:
```csharp
// 调试预览器也传递Pawn
knowledgeInjection = library.InjectKnowledgeWithDetails(
    "", 
    settings.maxInjectedKnowledge,
    out knowledgeScores,
    selectedPawn  // ? 传递选中的Pawn
);
```

---

## ?? 总结

### 核心改进

? **自动提取角色关键词**
- 年龄段（婴儿/儿童/青少年/成人）
- 性别
- 特质
- 名字

? **更智能的匹配**
- 不再只依赖用户输入
- 结合角色信息进行匹配
- 提高相关常识的匹配率

? **解决了婴儿等特殊角色的问题**
- 婴儿说话会自动注入"婴儿不会说话"的规则
- 儿童说话会自动注入"儿童说话简单"的规则
- 不同特质的角色会自动匹配对应的风格

### 使用建议

1. **降低常识阈值**: 0.10 → 0.05
2. **添加同义词**: "婴儿" → "婴儿, 宝宝, baby"
3. **提高重要性**: 核心规则设为 1.0
4. **使用调试预览器**: 验证常识是否被正确注入

---

**问题已解决！** ??

现在您设置的"婴儿不会说话"常识会在以下情况自动注入：
- 对婴儿说话时
- 婴儿自己说话时
- 任何涉及婴儿的对话场景

只要确保：
1. ? 关键词包含"婴儿"（或同义词）
2. ? 重要性足够高（建议1.0）
3. ? 阈值足够低（建议0.05）
