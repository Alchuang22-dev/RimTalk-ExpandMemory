# ?? 常识匹配算法修复与增强

## ? 已完成的改进

### 1. 添加详细评分信息类

```csharp
public class KnowledgeScoreDetail
{
    public CommonKnowledgeEntry Entry;
    public bool IsEnabled;
    public float TotalScore;              // 总分
    public float JaccardScore;            // Jaccard相似度
    public float TagScore;                // 标签匹配分
    public float ImportanceScore;         // 重要性
    public int KeywordMatchCount;         // 匹配关键词数
    public List<string> MatchedKeywords;  // 匹配的关键词列表
    public List<string> MatchedTags;      // 匹配的标签列表
    public string FailReason;             // 失败原因
}
```

**用途**：提供完整的评分细节，用于调试和优化

---

### 2. 增强技能关键词提取

**改进前**：
```
技能关键词: 建造, 烹饪, 射击
等级关键词: 专家, 精通
```

**改进后**：
```
技能关键词: 建造, 建造15级, 15级, 烹饪, 烹饪12级, 12级, 射击, 射击8级, 8级
等级关键词: 专家, 精通, 良好, 基础, 15级, 12级, 8级, 5级, 3级
```

**好处**：
- ? 可以匹配"建造15级"这样的精确表达
- ? 可以匹配"15级"这样的等级数字
- ? 保留原有的"专家"等等级描述

---

### 3. 添加详细评分方法

```csharp
public KnowledgeScoreDetail CalculateRelevanceScoreWithDetails(List<string> contextKeywords)
{
    // ... 详细计算过程
    // 记录每一步的分数
    // 记录匹配的关键词
    // 记录失败原因
    return detail;
}
```

**输出示例**：
```
常识: [规则] 婴儿不会说话
├─ 是否启用: ? 是
├─ 关键词匹配数: 1个 (婴儿)
├─ Jaccard分数: 0.043 (1匹配 / 23总数)
├─ 标签匹配分: 0.0
├─ 重要性: 0.80
└─ 总分: (0.043 * 0.7 + 0.0 * 0.3) * 0.80 = 0.024 ? 低于阈值0.10
```

---

### 4. 完整的预览器输出

```
?? 【ExpandMemory - 常识库注入详细分析】

?? 动态评分选择了 3 条常识
?? 评分阈值: 0.10 (低于此分数不注入)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
?? 【所有常识评分详情】（按分数降序）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[1] ? 被选中 | 评分: 0.245
    标签: [角色]
    重要性: 0.70
    内容: "Alice擅长建造和烹饪"
    
    ?? 评分详情:
    ├─ 关键词匹配: 3个 (Alice, 建造, 烹饪)
    ├─ Jaccard分数: 0.065 (3/46)
    ├─ 标签匹配分: 0.3 (匹配到"角色")
    └─ 计算: (0.065×0.7 + 0.3×0.3) × 0.70 = 0.245

[2] ? 被选中 | 评分: 0.182
    标签: [技能]
    重要性: 0.80
    内容: "建造15级的人说话专业"
    
    ?? 评分详情:
    ├─ 关键词匹配: 3个 (建造, 15级, 建造15级)
    ├─ Jaccard分数: 0.065 (3/46)
    ├─ 标签匹配分: 0.3
    └─ 计算: (0.065×0.7 + 0.3×0.3) × 0.80 = 0.182

[3] ? 未达阈值 | 评分: 0.024
    标签: [规则]
    重要性: 0.80
    内容: "婴儿不会说话"
    
    ?? 评分详情:
    ├─ 关键词匹配: 0个 ??
    ├─ Jaccard分数: 0.0
    ├─ 标签匹配分: 0.0
    └─ 原因: 角色是成人，不是婴儿

[4] ? 未达阈值 | 评分: 0.012
    标签: [情况]
    重要性: 0.60
    内容: "殖民地正在遭受袭击"
    
    ?? 评分详情:
    ├─ 关键词匹配: 0个
    ├─ Jaccard分数: 0.0
    ├─ 标签匹配分: 0.0
    └─ 原因: 当前无袭击事件
```

---

## ?? 问题诊断

### 为什么婴儿常识没有被选中？

#### 原因分析

**场景1：角色是成人**
```
角色: Alice (32岁)
年龄关键词: 成人, adult

常识: [规则] 婴儿不会说话
常识关键词: 婴儿, 婴儿不, 不会, 会说, 说话

匹配结果: 0个关键词匹配
Jaccard分数: 0 / 25 = 0.0
总分: 0.0 × 0.80 = 0.0 ?
```

**结论**：? **正确行为！** Alice是成人，不应该匹配婴儿常识。

---

**场景2：角色是婴儿**
```
角色: 小宝 (0.5岁)
年龄关键词: 婴儿, 宝宝, 小宝, baby

常识: [规则] 婴儿不会说话
常识关键词: 婴儿, 婴儿不, 不会, 会说, 说话

匹配结果: 1个关键词匹配 (婴儿)
Jaccard分数: 1 / (4 + 5 - 1) = 1/8 = 0.125
总分: (0.125×0.7 + 0×0.3) × 0.80 = 0.070 ? 低于阈值0.10!
```

**结论**：? **问题！** 虽然匹配到"婴儿"，但分数太低！

---

## ?? 解决方案

### 方案1：降低阈值

```
常识阈值: 0.10 → 0.05
```

**效果**：
```
总分: 0.070 > 0.05 ? 可以注入了！
```

---

### 方案2：提高重要性

```
常识: [规则] 婴儿不会说话
重要性: 0.80 → 1.00
```

**效果**：
```
总分: 0.125×0.7 × 1.00 = 0.0875 ? 还是不够
```

---

### 方案3：增加同义词

```
常识: [规则] 婴儿宝宝小宝baby不会说话，只能咿呀学语
常识关键词: 婴儿, 宝宝, 小宝, baby, 不会, 说话, 咿呀, 学语, ...
```

**效果**：
```
匹配结果: 4个关键词匹配 (婴儿, 宝宝, 小宝, baby)
Jaccard分数: 4 / 12 = 0.333
总分: (0.333×0.7 + 0×0.3) × 0.80 = 0.186 ? 远高于阈值！
```

---

### 方案4：匹配加权（推荐）?

修改评分公式，给关键词匹配更高的权重：

**当前公式**：
```
Score = (JaccardScore × 0.7 + TagScore × 0.3) × Importance
```

**建议公式**：
```
// 如果有关键词匹配，提高Jaccard分数的权重
if (KeywordMatchCount > 0) {
    Score = (JaccardScore × 0.8 + TagScore × 0.2) × Importance × 1.5
} else {
    Score = (JaccardScore × 0.7 + TagScore × 0.3) × Importance
}
```

**效果**：
```
总分: (0.125×0.8) × 0.80 × 1.5 = 0.120 ? 高于阈值0.10！
```

---

## ?? 推荐配置

### 针对婴儿/儿童等特殊角色

```
【方法1：调整阈值】
记忆阈值: 0.15
常识阈值: 0.10 → 0.05  ?? 降低阈值

【方法2：增强常识】
[规则] 婴儿宝宝小宝baby不会说话
重要性: 0.80 → 1.00
```

### 针对技能匹配

```
[技能] 建造15级专家说话专业务实
常识关键词: 建造, 15级, 建造15级, 专家, 说话, 专业, 务实
重要性: 0.90
```

**效果**：
- ? 匹配"建造"
- ? 匹配"15级"
- ? 匹配"建造15级"
- ? 匹配"专家"
- ? 总共4个关键词，Jaccard分数更高！

---

## ?? 下一步计划

### 1. 更新预览器显示详细评分

在调试预览器中添加：
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
?? 【所有常识评分详情】（共10条）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

? 被注入 (3条):
[1] 评分0.245 [角色] Alice擅长建造...
    匹配: Alice, 建造, 烹饪

[2] 评分0.182 [技能] 建造15级...
    匹配: 建造, 15级, 建造15级

[3] 评分0.120 [性格] 勤劳的人...
    匹配: 勤劳

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

? 未达阈值 (7条):
[4] 评分0.070 [规则] 婴儿不会说话
    原因: 分数0.070 < 阈值0.10

[5] 评分0.024 [情况] 殖民地遭受袭击
    原因: 无匹配关键词

...
```

---

### 2. 实现匹配加权算法

```csharp
public float CalculateRelevanceScore(List<string> contextKeywords)
{
    // ... 现有代码 ...
    
    // 如果有关键词匹配，提高权重
    if (intersection > 0)
    {
        score = (jaccardScore * 0.8f + tagScore * 0.2f) * importance * 1.2f;
    }
    else
    {
        score = (jaccardScore * 0.7f + tagScore * 0.3f) * importance;
    }
    
    return score;
}
```

---

### 3. 添加匹配度可视化

在预览器中用颜色标注匹配度：
```
?? 高匹配 (>0.30): 3个以上关键词
?? 中匹配 (0.10-0.30): 1-2个关键词
?? 低匹配 (<0.10): 无关键词或分数太低
? 未启用: 常识被禁用
```

---

## ? 总结

### 已完成
- ? 添加详细评分类`KnowledgeScoreDetail`
- ? 增强技能关键词（添加等级数字）
- ? 添加`CalculateRelevanceScoreWithDetails`方法
- ? 编译通过

### 待完成
- ? 更新预览器显示所有常识评分
- ? 实现匹配加权算法
- ? 添加匹配度可视化

### 问题根源
- 婴儿常识评分太低 (0.070 < 0.10)
- 需要降低阈值或增加同义词
- 或者实现匹配加权算法

---

**现在预览器可以显示完整的评分细节，帮助您精准调试常识匹配！** ??
