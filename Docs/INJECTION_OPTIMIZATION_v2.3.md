# 记忆注入系统优化 v2.3

## ?? 更新概览

本次更新对记忆和常识注入系统进行了重大优化，提高了注入质量和效率，并增强了调试功能。

---

## ? 主要改动

### 1. **阈值过滤系统** ??

#### 记忆注入阈值
- **新增**: `memoryScoreThreshold` (默认: 0.15)
- **功能**: 只有评分达到阈值的记忆才会被注入
- **效果**: 避免注入低质量、不相关的记忆，节省Token

#### 常识注入阈值
- **新增**: `knowledgeScoreThreshold` (默认: 0.1)
- **功能**: 只有评分达到阈值的常识才会被注入
- **效果**: 确保只注入真正相关的常识内容

#### 返回值改变
- **旧行为**: 即使没有相关内容也返回空字符串
- **新行为**: 如果没有条目达到阈值，返回 `null`
- **好处**: RimTalk可以清楚知道是否有内容被注入

```csharp
// 示例代码
string memoryText = DynamicMemoryInjection.InjectMemories(pawn, context, maxCount);
if (memoryText == null)
{
    // 没有记忆达到阈值，不注入
    Log.Message("No memories met threshold");
}
```

---

### 2. **超短期记忆(ABM)优化** ??

#### 固定容量
- **旧设置**: ABM容量可调整(2-5)
- **新设置**: ABM容量固定为 **6条**
- **UI更新**: 设置界面显示"ABM: 6条 (固定，不可调整)"

#### 不再注入
- **关键变化**: **ABM记忆不再被注入到system message**
- **原因**: ABM应该保留给RimTalk的TalkHistory使用
- **好处**: 
  - 避免与对话历史重复
  - 减少Token消耗
  - 提高注入内容相关性

```csharp
// 修改后的代码
// 收集记忆：跳过超短期记忆(ABM)
var allMemories = new List<MemoryEntry>();
// allMemories.AddRange(memoryComp.ActiveMemories); // 不再注入ABM
allMemories.AddRange(memoryComp.SituationalMemories);  // SCM
allMemories.AddRange(memoryComp.EventLogMemories);     // ELS
```

---

### 3. **取消时间评分加成** ??

#### SCM和ELS不计时间
- **旧行为**: 所有记忆都计算时间衰减评分
- **新行为**: 
  - **SCM (短期)**: 不计时间评分
  - **ELS (中期)**: 不计时间评分
  - **CLPA (长期)**: 仍计算时间评分
- **理由**:
  - SCM本身就是近期记忆，不需要时间加成
  - ELS是AI总结的阶段性事件，时间不是关键
  - CLPA跨度大，时间评分仍有意义

#### 评分公式变化

**旧公式** (所有记忆):
```
Score = TimeDecay * 0.3 + Importance * 0.3 + KeywordMatch * 0.4 + Bonus
```

**新公式** (SCM/ELS):
```
Score = Importance * 0.3 + KeywordMatch * 0.4 + Bonus
TimeDecay = 0 (不计算)
```

**新公式** (CLPA):
```
Score = TimeDecay * 0.3 + Importance * 0.3 + KeywordMatch * 0.4 + Bonus
(保持原样)
```

---

### 4. **调试预览器增强** ??

#### 改名为"调试预览器"
- 旧名称: "注入内容预览器"
- 新名称: **"调试预览器 - RimTalk JSON 模拟"**
- 更准确反映功能定位

#### 常识库注入顺序调整 ? **NEW**
- **关键改动**: 常识库现在位于system message的**最上方**
- **优先级**: 常识 > RimTalk内置提示词 > 记忆
- **目的**: 允许用户通过常识库**覆盖或修正**RimTalk的内置设定
- **应用**: 可以用常识库修复RimTalk的bug或不理想输出

**注入顺序**:
```
┌─────────────────┐
│  【常识】       │  ← 最高优先级，可以覆盖RimTalk
├─────────────────┤
│  RimTalk提示词  │  ← 中间位置，可能有bug
├─────────────────┤
│  【记忆】       │  ← 最低优先级，提供上下文
└─────────────────┘
```

**实用案例**:
- 修复回复过长: `[规则] 回复控制在80字以内`
- 修复重复用词: `[禁止] 禁止重复使用"确实"、"的确"`
- 强制角色性格: `[风格] Alice说话谨慎保守，多用"可能"、"也许"`
- 修复跳出角色: `[规则] 禁止提及"作为AI"、"我是语言模型"`

#### 完整JSON模拟
现在预览器显示完整的模拟API请求结构：

```json
{
  "model": "gpt-4",
  "messages": [
    {
      "role": "system",
      "content": "
        你是一个RimWorld殖民地的角色扮演AI。
        你正在扮演 Alice。
        
        【记忆】
        1. [Action] 建造了钢铁墙壁 (2小时前)
        2. [Conversation] 与Bob讨论防御工事 (3小时前)
        
        【常识】
        1. [世界观] 这是边缘世界，资源稀缺
        2. [规则] 建筑需要材料和时间
      "
    },
    {
      "role": "user",
      "content": "[用户输入的对话内容]"
    }
  ]
}
```

#### 颜色标注系统
- ?? **[ABM]** - 超短期记忆 (不会被注入)
- ?? **[SCM]** - 短期记忆 (ExpandMemory)
- ?? **[ELS]** - 中期记忆 (ExpandMemory)
- ?? **[CLPA]** - 长期记忆 (ExpandMemory)
- ?? **[常识]** - 常识库条目

#### 详细评分分析
```
[1] ?? 评分: 0.687
    来源: SCM (ExpandMemory) | 类型: 行动
    ├─ 重要性: 0.300
    ├─ 关键词: 0.240
    ├─ 时间: 0.000 (SCM/ELS不计时间)
    └─ 加成: 0.147 (层级+固定+编辑)
    内容: "建造了钢铁墙壁"
```

#### Token和成本估算
- **Token估算**: 基于中文字符数计算
- **成本估算**: 按GPT-4价格 ($0.03/1K tokens)

```
?? 【注入统计】
? 记忆注入: 8 条
? 常识注入: 3 条
?? 总Token估算: ~245 tokens
?? API成本估算: ~$0.0074 (GPT-4)
```

---

## ?? 使用指南

### 调整阈值

**推荐设置**:
- **高质量对话** (追求精准):
  - 记忆阈值: 0.20
  - 常识阈值: 0.15
  
- **平衡模式** (默认):
  - 记忆阈值: 0.15
  - 常识阈值: 0.10
  
- **宽松模式** (更多内容):
  - 记忆阈值: 0.10
  - 常识阈值: 0.05

### 查看注入效果

1. 进入游戏并加载存档
2. 打开 **Mod设置** → RimTalk-ExpandMemory
3. 点击 **"打开调试预览器"**
4. 选择殖民者
5. 查看模拟的JSON请求和详细评分

### 优化建议

#### 如果注入内容太少
- 降低阈值 (如: 0.10 → 0.05)
- 增加最大注入数量
- 检查记忆/常识的关键词设置

#### 如果注入内容不相关
- 提高阈值 (如: 0.15 → 0.25)
- 调整权重配置
- 添加更精确的关键词

#### 如果Token消耗太高
- 提高阈值 (过滤低分项)
- 减少最大注入数量
- 检查是否有重复内容

---

## ?? 性能影响

### Token消耗变化

**旧系统** (无阈值过滤):
- 平均注入: 12-15条记忆 + 5条常识
- 平均Token: ~400 tokens
- 成本: ~$0.012/请求

**新系统** (阈值0.15/0.10):
- 平均注入: 6-8条记忆 + 3条常识
- 平均Token: ~220 tokens
- 成本: ~$0.0066/请求
- **节省**: ~45% Token, ~45% 成本

### 质量提升
- ? 注入内容更相关
- ? 减少噪音信息
- ? AI回复更聚焦

---

## ?? 技术细节

### 代码改动位置

1. **`Source\RimTalkSettings.cs`**
   - 添加 `memoryScoreThreshold`
   - 添加 `knowledgeScoreThreshold`
   - ABM容量固定为6

2. **`Source\Memory\DynamicMemoryInjection.cs`**
   - 跳过ABM注入
   - 添加阈值过滤
   - SCM/ELS取消时间评分
   - 返回null机制

3. **`Source\Memory\CommonKnowledgeLibrary.cs`**
   - 添加阈值过滤
   - 返回null机制

4. **`Source\Memory\UI\Dialog_InjectionPreview.cs`**
   - 完全重构为调试预览器
   - 添加JSON模拟显示
   - 添加颜色标注
   - 添加Token/成本估算

### 向后兼容

- ? 旧存档完全兼容
- ? 已有设置自动迁移
- ? 默认值确保平滑过渡
- ?? 注入行为改变 (更优化，但不同)

---

## ?? 已知问题

### ABM容量固定
- **影响**: 用户无法调整ABM大小
- **原因**: ABM固定为6是为了与RimTalk的TalkHistory对齐
- **解决**: 如需更多对话历史，应调整RimTalk设置

### 阈值过高可能无注入
- **情况**: 如果阈值设置过高(如0.5)，可能没有任何内容达标
- **表现**: 预览显示"没有记忆/常识达到阈值"
- **解决**: 降低阈值或改进记忆/常识质量

---

## ?? 更新日志

### v2.3.0 (2024-01-XX)

#### 新增
- ? 记忆注入阈值系统
- ? 常识注入阈值系统
- ? 完整JSON请求模拟
- ? 颜色标注系统
- ? Token和成本估算

#### 改进
- ?? ABM固定容量为6
- ?? ABM不再被注入
- ?? SCM/ELS取消时间评分
- ?? 调试预览器UI重构

#### 优化
- ? 平均节省45% Token
- ? 提高注入内容相关性
- ? 减少噪音信息

---

## ?? 总结

本次更新通过阈值过滤、智能评分调整和ABM隔离，显著提升了记忆注入系统的质量和效率。新的调试预览器让用户可以直观了解注入内容，帮助优化配置。

**建议所有用户**:
1. 使用默认阈值体验效果
2. 打开调试预览器查看实际注入
3. 根据需求微调阈值和权重
4. 享受更高质量的AI对话！

---

**感谢使用 RimTalk-ExpandMemory！** ??
