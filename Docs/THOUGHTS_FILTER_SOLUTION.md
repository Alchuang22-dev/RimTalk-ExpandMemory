# RimWorld Thoughts系统与常识库禁用方案

## ?? 问题分析

### 当前情况

**用户反馈**:
- 在常识库中设置禁用词（如"不要复述看法"）无效
- RimWorld的Thoughts(看法/想法)内容位于**system content之后**
- 常识库虽然在最上方，但无法阻止AI复述这些内容

### RimTalk的实际消息结构

根据您的描述，RimTalk的实际结构可能是：

```json
{
  "messages": [
    {
      "role": "system",
      "content": "
        【常识】
        [规则] 不要复述或提及角色的想法和看法
        
        RimTalk提示词
        
        【角色信息卡片】
        ...
        
        【ExpandMemory记忆】
        ...
      "
    },
    {
      "role": "user",
      "content": "
        [用户实际输入]
        
        【当前想法/看法】?? RimWorld Thoughts系统
        - 吃了美味的饭菜 (+5)
        - 房间很脏 (-3)
        - 最近睡眠充足 (+2)
        ...
      "
    }
  ]
}
```

或者：

```json
{
  "messages": [
    {
      "role": "system",
      "content": "..."
    },
    {
      "role": "assistant",
      "content": "【当前想法/看法】..."  // RimTalk可能在这里注入
    },
    {
      "role": "user",
      "content": "用户输入"
    }
  ]
}
```

---

## ? 为什么常识库禁用无效？

### 原因1: Thoughts在user message中
如果Thoughts在**user message**中：
```
常识库(system) → 无法直接阻止user message的内容被AI看到
```

### 原因2: Thoughts在assistant history中
如果Thoughts在**assistant message**中：
```
常识库(system) → 无法阻止AI基于历史消息回复
```

### 原因3: 提示词优先级问题
即使在system中，AI可能认为：
```
用户明确提供的信息(Thoughts) > 常识库的禁止规则
```

---

## ? 解决方案

### 方案1: 强化常识库禁止规则 ? **推荐优先尝试**

在常识库中添加**更强硬、更明确**的禁止规则：

```
[必须] 绝对禁止提及、复述或引用"想法"、"看法"、"心情修正"等游戏机制内容
[必须] 如果看到"+5"、"-3"这类数字修正，完全忽略它们
[必须] 只从角色第一人称视角描述感受，不要说"我的想法是"或"我有个看法"
[禁止] 禁止使用"吃了美味的饭菜(+5)"这类带括号数字的表达
[禁止] 禁止提及"心情修正"、"想法列表"、"buff"、"debuff"等游戏术语
[规则] 将游戏机制转化为自然的第一人称叙述
```

**重要性设置**: **1.0** (最高优先级)

**为什么可能有效**:
- 更具体、更明确的禁止规则
- 提供了替代方案（"转化为自然叙述"）
- 最高优先级确保AI优先考虑

---

### 方案2: 转化而非禁止 ?? **更实用**

与其禁止AI使用Thoughts，不如**教AI如何转化**它们：

```
[规则] 将游戏提供的"想法"转化为自然的第一人称感受描述
[风格] 看到"吃了美味的饭菜(+5)"时，说"刚才那顿饭真不错"而不是复述原文
[风格] 看到"房间很脏(-3)"时，说"房间有点乱，得找时间清理"而不是复述数字
[示例] 错误："我有个想法：吃了美味的饭菜(+5)" → 正确："刚才那顿饭真不错，心情好多了"
[示例] 错误："我的看法是房间很脏(-3)" → 正确："房间有点乱，看着不太舒服"
```

**效果**:
- AI仍然能使用Thoughts信息（这些信息是有价值的）
- 但会用自然的方式表达，而非机械复述

---

### 方案3: 示例驱动 ??? **最有效**

提供**正反示例**，让AI学习正确的表达方式：

```
[示例-错误] "我的想法：吃了美味的饭菜(+5)，房间很脏(-3)"
[示例-正确] "刚才那顿饭真不错！不过房间有点乱，得找时间打扫"

[示例-错误] "我有以下看法：睡眠充足(+2)，工作繁重(-4)"
[示例-正确] "最近睡得还不错，但工作确实有点累"

[示例-错误] "当前心情修正：+5 美味饭菜，-3 脏房间"
[示例-正确] "总体来说心情还行，饭菜不错，就是房间该打扫了"

[规则] 严格按照"正确示例"的风格回答，绝不使用"错误示例"的格式
[规则] 永远不要说"我的想法是"、"我的看法是"、"心情修正"等词
[规则] 永远不要使用括号数字如"(+5)"、"(-3)"
```

**重要性**: **1.0**

---

### 方案4: 预处理过滤 (需要修改代码)

如果上述方案都不够理想，可以在ExpandMemory中**预处理过滤**Thoughts内容。

#### 实现位置
在RimTalk调用ExpandMemory注入之前，过滤掉Thoughts相关内容。

#### 实现思路
```csharp
// 在注入前过滤Thoughts
public static string FilterThoughtsFromContext(string context)
{
    // 移除RimWorld Thoughts格式
    // 模式: "想法: XXX(+5)" 或 "Thought: XXX(+5)"
    var filtered = Regex.Replace(context, 
        @"(想法|看法|Thought|Mood)[:：]\s*[^(\n]+\([+\-]\d+\)", 
        "", 
        RegexOptions.IgnoreCase);
    
    // 移除独立的修正数字
    filtered = Regex.Replace(filtered, 
        @"\([+\-]\d+\)", 
        "");
    
    return filtered;
}
```

**但这需要修改RimTalk本体**，不是ExpandMemory能单独完成的。

---

## ?? 推荐方案组合

### 立即可用（无需代码修改）

在常识库中同时添加：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【禁止游戏机制复述 - 优先级最高】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[必须] 绝对禁止复述游戏提供的"想法"、"看法"、"心情修正"等机制内容
[必须] 绝对禁止使用括号数字如"(+5)"、"(-3)"的格式
[必须] 将游戏机制信息转化为自然的第一人称感受

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【转化规则 - 如何表达感受】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[规则] 看到"吃了美味的饭菜(+5)" → 说"刚才那顿饭真不错"
[规则] 看到"房间很脏(-3)" → 说"房间有点乱，该打扫了"
[规则] 看到"睡眠充足(+2)" → 说"最近睡得还不错"
[规则] 看到"工作繁重(-4)" → 说"最近工作确实有点累"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【禁用词汇列表】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[禁止] 禁止使用词汇："我的想法是"、"我的看法是"、"心情修正"
[禁止] 禁止使用词汇："想法列表"、"看法列表"、"buff"、"debuff"
[禁止] 禁止使用词汇："当前想法"、"当前看法"、"心情加成"
[禁止] 禁止使用格式：任何带括号数字的表达，如"XXX(+5)"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【正确示例】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

? 错误: "我的想法：吃了美味的饭菜(+5)，房间很脏(-3)"
? 正确: "刚才那顿饭真不错！不过房间有点乱，得找时间打扫"

? 错误: "我有以下看法：睡眠充足(+2)，工作繁重(-4)"
? 正确: "最近睡得还不错，但工作确实有点累"

? 错误: "当前心情修正：+3 (净值)"
? 正确: "总体来说心情还行"

[规则] 严格按照"正确示例"的自然表达风格
[规则] 永远不要模仿"错误示例"的机械复述格式
```

**重要性**: **1.0** (最高)

---

## ?? 测试验证

### 测试步骤

1. **添加上述常识库条目**
   - 重要性设为 1.0
   - 确保已启用

2. **使用调试预览器查看**
   ```
   Mod设置 → 打开调试预览器 → 查看JSON
   ```
   
   确认常识库在最上方，内容完整

3. **实际对话测试**
   - 触发一些Thoughts（吃饭、睡觉、清理等）
   - 观察AI是否还会说"我的想法是XXX(+5)"
   - 观察AI是否改用自然表达

4. **调整策略**
   - 如果仍然复述：增加更多示例
   - 如果完全忽略Thoughts：调整为"转化"而非"禁止"

---

## ?? 效果对比

### 修复前
```
用户: "你最近怎么样？"

AI: "我最近还不错。我的想法：吃了美味的饭菜(+5)，
     房间很脏(-3)，睡眠充足(+2)。总的心情修正是+4。"
```
? 机械复述游戏机制，破坏沉浸感

### 修复后
```
用户: "你最近怎么样？"

AI: "还不错！刚才那顿饭做得挺好的，心情也好了不少。
     就是房间有点乱，得找时间打扫一下。不过最近睡得
     挺好的，精神头还行。"
```
? 自然表达，保持角色扮演沉浸感

---

## ?? 进阶方案：情绪转化系统

如果想要更精细的控制，可以建立**情绪转化映射表**：

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【情绪转化映射表】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

正面情绪 (+1到+3):
[转化] "吃了美味的饭菜" → "饭菜不错"、"吃得挺好"
[转化] "睡眠充足" → "睡得还行"、"精神不错"
[转化] "房间宽敞" → "房间挺舒服的"

正面情绪 (+4到+6):
[转化] "吃了极品饭菜" → "这顿饭太棒了！"
[转化] "完成了杰作" → "今天成果不错，挺有成就感"

负面情绪 (-1到-3):
[转化] "房间很脏" → "房间有点乱"、"该打扫了"
[转化] "睡眠不足" → "有点累"、"没睡够"

负面情绪 (-4到-6):
[转化] "极度疲劳" → "真的太累了"、"需要好好休息"
[转化] "目睹死亡" → "最近发生了些不好的事，心情很沉重"

[规则] 根据情绪强度选择合适的表达强度
[规则] 保持第一人称自然叙述，不使用游戏术语
```

---

## ?? 注意事项

### 1. Thoughts信息是有价值的
- ? 不要完全忽略Thoughts（它们提供重要的角色状态）
- ? 应该转化它们为自然表达

### 2. 平衡沉浸感和信息量
- 过度禁止可能导致AI回复缺乏细节
- 推荐"转化"策略而非"完全禁止"

### 3. 测试不同场景
- 正面心情（多个+5）
- 负面心情（多个-5）
- 极端情况（心情崩溃）

---

## ?? 总结

### 问题根源
常识库在system content中，但Thoughts可能在user message或后续位置，导致禁止规则优先级不足。

### 最佳解决方案
1. **加强禁止规则**（明确、具体、高优先级）
2. **提供转化规则**（教AI如何正确表达）
3. **大量正反示例**（让AI学习正确模式）

### 立即行动
1. 复制上述常识库模板
2. 添加到常识库管理器
3. 设置重要性为 1.0
4. 使用调试预览器验证
5. 实际测试效果

如果以上方案仍然无效，可能需要：
- 提供RimTalk的实际JSON输出（查看Thoughts具体位置）
- 考虑向RimTalk作者反馈此问题
- 或者修改RimTalk代码添加Thoughts过滤功能

---

**祝您成功修复这个问题！** ??
