# 调试预览器 - JSON模拟输出示例

## ?? 测试场景说明

**殖民者**: Alice  
**时间**: 第5天 下午3点  
**注入模式**: 动态评分  
**配置**: 最大记忆10条, 最大常识5条, 记忆阈值0.15, 常识阈值0.10

---

## ?? 完整的 JSON 请求结构

```json
{
  "model": "gpt-4",
  "messages": [
    {
      "role": "system",
      "content": "
        【常识】?? 优先级最高，可以覆盖RimTalk内置提示词
        1. [世界观] 这是边缘世界，一个遥远的边境星球，科技水平参差不齐
        2. [规则] 建筑需要材料和时间，钢铁墙壁比木墙更坚固但需要更多资源
        3. [殖民地] 我们的殖民地名叫'希望之地'，有12名殖民者和各种防御设施
        4. [威胁] 海盗和机械族会定期袭击，需要保持警惕
        5. [角色] Alice擅长建造和烹饪，是殖民地的后勤支柱
        
        你是一个RimWorld殖民地的角色扮演AI。 ?? RimTalk内置提示词（中间位置）
        你正在扮演 Alice。
        
        【角色信息卡片】?? RimTalk生成的详细角色信息
        姓名: Alice
        性别: 女性
        年龄: 32岁
        
        背景故事: Alice曾是一名军事工程师，在军队服役12年后退役。
        她精通建筑和防御工事的设计，也自学了烹饪技能。在登陆
        边缘世界后，她成为殖民地的后勤负责人。
        
        特质:
        - 勤劳 (Hard Worker): 工作速度+35%
        - 细心 (Careful): 建造失败率-50%
        - 夜猫子 (Night Owl): 夜间工作效率+20%
        
        技能:
        - 建造: 15级 (专家)
        - 烹饪: 12级 (精通)
        - 射击: 8级 (良好)
        - 医疗: 5级 (基础)
        - 种植: 3级 (新手)
        
        健康状况: 良好，无伤病
        心情: 满意 (65/100)
        
        关系:
        - Bob (丈夫): 亲密度 +85
        - Charlie (朋友): 亲密度 +45
        - David (同事): 亲密度 +20
        
        【记忆】?? 提供上下文，优先级最低
        1. [Action] 建造了钢铁墙壁 (2小时前)
        2. [Action] 修理了损坏的发电机 (3小时前)
        3. [Conversation] 与Bob讨论防御工事的布局 (4小时前)
        4. [Action] 烹饪了简单的饭菜 (5小时前)
        5. [Event] 成功击退了海盗袭击 (1天前)
        6. [Conversation] 与医生讨论了伤员救治方案 (1天前)
        7. [Action] 研究了微电子学技术 (2天前)
        8. [Event] 殖民地举办了篝火晚会 (3天前)
      "
    },
    {
      "role": "user",
      "content": "Alice，你能告诉我关于昨天袭击的事情吗？"
    }
  ],
  "temperature": 0.7,
  "max_tokens": 500
}
```

### ?? 注入顺序说明

**优先级从高到低**:
1. **【常识】** - 最上方，优先级最高 ?
   - 可以覆盖或修正RimTalk内置提示词
   - 用于修复bug或不理想的输出
   - 例如: 添加 `[规则] 回复必须控制在100字以内` 可以覆盖RimTalk的冗长设定

2. **RimTalk内置提示词** - 基础系统提示
   - RimTalk的基础系统提示词
   - 定义AI的基本角色和行为

3. **【角色信息卡片】** - RimTalk核心功能 ? **重要**
   - **这是RimTalk最核心的功能之一**
   - 包含角色的详细信息：背景、特质、技能、关系等
   - 通常包含大量Token（可能200-500 tokens）
   - 信息非常详细和准确
   - **常识库可以补充或修正这些信息**

4. **【记忆】** - 最下方
   - 提供对话上下文和历史信息
   - 由ExpandMemory提供
   - 不应该用于修改规则或设定

---

## ?? 【ExpandMemory - 记忆注入详细分析】

?? 动态评分选择了 **8 条记忆**  
?? 评分阈值: **0.15** (低于此分数不注入)

### 记忆详情

#### [1] ?? 评分: 0.687
```
来源: SCM (ExpandMemory) | 类型: 行动
├─ 重要性: 0.300
├─ 关键词: 0.240  (匹配: 建造、钢铁、墙壁)
├─ 时间: 0.000 (SCM/ELS不计时间)
└─ 加成: 0.147 (层级+固定+编辑)
内容: "建造了钢铁墙壁"
```

#### [2] ?? 评分: 0.652
```
来源: SCM (ExpandMemory) | 类型: 行动
├─ 重要性: 0.280
├─ 关键词: 0.220  (匹配: 修理、发电机)
├─ 时间: 0.000 (SCM/ELS不计时间)
└─ 加成: 0.152 (层级+固定+编辑)
内容: "修理了损坏的发电机"
```

#### [3] ?? 评分: 0.598
```
来源: SCM (ExpandMemory) | 类型: 对话
├─ 重要性: 0.250
├─ 关键词: 0.200  (匹配: Bob、讨论、防御)
├─ 时间: 0.000 (SCM/ELS不计时间)
└─ 加成: 0.148 (层级+固定+编辑)
内容: "与Bob讨论防御工事的布局"
```

#### [4] ?? 评分: 0.543
```
来源: SCM (ExpandMemory) | 类型: 行动
├─ 重要性: 0.220
├─ 关键词: 0.180  (匹配: 烹饪、饭菜)
├─ 时间: 0.000 (SCM/ELS不计时间)
└─ 加成: 0.143 (层级+固定+编辑)
内容: "烹饪了简单的饭菜"
```

#### [5] ?? 评分: 0.712
```
来源: ELS (ExpandMemory) | 类型: 事件
├─ 重要性: 0.450  (重要事件)
├─ 关键词: 0.180  (匹配: 海盗、袭击)
├─ 时间: 0.000 (SCM/ELS不计时间)
└─ 加成: 0.082 (层级加成)
内容: "成功击退了海盗袭击"
```
?? **用户问题直接相关** - "昨天袭击"

#### [6] ?? 评分: 0.564
```
来源: ELS (ExpandMemory) | 类型: 对话
├─ 重要性: 0.350
├─ 关键词: 0.150  (匹配: 医生、伤员)
├─ 时间: 0.000 (SCM/ELS不计时间)
└─ 加成: 0.064 (层级加成)
内容: "与医生讨论了伤员救治方案"
```

#### [7] ?? 评分: 0.487
```
来源: ELS (ExpandMemory) | 类型: 行动
├─ 重要性: 0.300
├─ 关键词: 0.130  (匹配: 研究、技术)
├─ 时间: 0.000 (SCM/ELS不计时间)
└─ 加成: 0.057 (层级加成)
内容: "研究了微电子学技术"
```

#### [8] ?? 评分: 0.423
```
来源: CLPA (ExpandMemory) | 类型: 事件
├─ 重要性: 0.280
├─ 关键词: 0.100  (匹配: 殖民地、篝火)
├─ 时间: 0.023 (CLPA有时间评分，3天前衰减)
└─ 加成: 0.020 (CLPA层级加成较低)
内容: "殖民地举办了篝火晚会"
```

---

## ?? 【ExpandMemory - 常识库注入详细分析】

?? 动态评分选择了 **5 条常识**  
?? 评分阈值: **0.10** (低于此分数不注入)

### 常识详情

#### [1] ?? 评分: 0.450
```
标签: [世界观]
重要性: 0.90
内容: "这是边缘世界，一个遥远的边境星球，科技水平参差不齐"
```

#### [2] ?? 评分: 0.380
```
标签: [规则]
重要性: 0.80
内容: "建筑需要材料和时间，钢铁墙壁比木墙更坚固但需要更多资源"
```

#### [3] ?? 评分: 0.350
```
标签: [殖民地]
重要性: 0.70
内容: "我们的殖民地名叫'希望之地'，有12名殖民者和各种防御设施"
```

#### [4] ?? 评分: 0.325
```
标签: [威胁]
重要性: 0.75
内容: "海盗和机械族会定期袭击，需要保持警惕"
```
?? **与记忆[5]相关** - 提供海盗袭击的背景知识

#### [5] ?? 评分: 0.280
```
标签: [角色]
重要性: 0.60
内容: "Alice擅长建造和烹饪，是殖民地的后勤支柱"
```
?? **角色人设** - 补充Alice的核心特征

---

## ?? 【注入统计】

```
? 记忆注入: 8 条
   ├─ SCM (短期): 4 条
   ├─ ELS (中期): 3 条
   └─ CLPA (长期): 1 条

? 常识注入: 5 条
   ├─ 世界观: 1 条
   ├─ 规则: 1 条
   ├─ 殖民地: 1 条
   ├─ 威胁: 1 条
   └─ 角色: 1 条

?? 总Token估算: ~245 tokens
   ├─ 记忆部分: ~180 tokens
   └─ 常识部分: ~65 tokens

?? API成本估算: ~$0.0074 (GPT-4)
   (基于 $0.03 per 1K input tokens)
```

---

## ?? 【颜色标注说明】

| 标记 | 层级 | 说明 |
|------|------|------|
| ?? | ABM | 超短期记忆 (不会被注入，保留给 TalkHistory) |
| ?? | SCM | 短期记忆 (近期事件，无时间加成) |
| ?? | ELS | 中期记忆 (AI总结，无时间加成) |
| ?? | CLPA | 长期记忆 (核心人设，有时间加成) |
| ?? | 常识 | 常识库条目 (世界观/背景知识) |

---

## ?? 【评分算法解析】

### 记忆评分公式

**SCM/ELS** (不计时间):
```
Score = Importance * 0.3 + KeywordMatch * 0.4 + LayerBonus * 0.2 + SpecialBonus
```

**CLPA** (计时间):
```
Score = TimeDecay * 0.3 + Importance * 0.3 + KeywordMatch * 0.4 + LayerBonus * 0.2 + SpecialBonus
```

其中:
- `TimeDecay = exp(-hours_passed / 24)` (CLPA专用)
- `KeywordMatch = Jaccard(memory.keywords, context.keywords)`
- `LayerBonus`: SCM=0.7, ELS=0.4, CLPA=0.2
- `SpecialBonus`: Pinned=+0.5, UserEdited=+0.3

### 常识评分公式

```
Score = (JaccardSimilarity * 0.7 + TagMatch * 0.3) * Importance
```

其中:
- `JaccardSimilarity = intersection / union` (关键词交并比)
- `TagMatch`: 标签是否匹配上下文关键词
- `Importance`: 常识条目的重要性 (0-1)

---

## ?? 【此次注入的特点分析】

### 1. 响应用户提问
- 用户问 "昨天袭击的事情"
- 记忆[5] "成功击退了海盗袭击" 评分最高 (0.712)
- 常识[4] "海盗和机械族会定期袭击" 提供背景
- ? **高度相关，AI可以准确回答**

### 2. 补充角色背景
- 记忆[1-4] 展示Alice最近的活动 (建造、修理、烹饪)
- 常识[5] 说明Alice的核心技能
- ? **让AI回复更符合角色人设**

### 3. 世界观一致性
- 常识[1] 提供世界观设定
- 常识[3] 介绍殖民地情况
- ? **确保AI回复符合游戏世界**

### 4. Token效率
- 只注入了 **8条记忆** (而非全部20+条)
- 只注入了 **5条常识** (而非全部10+条)
- 评分阈值成功过滤了不相关内容
- ? **节省Token，提高质量**

---

## ?? 【预期的AI回复示例】

基于以上注入内容，AI可能的回复：

```
当然！昨天下午遭遇了一次相当激烈的海盗袭击。
那些该死的强盗企图攻破我们的防线，但幸好之前
我和Bob一起加固的钢铁墙壁发挥了作用。

袭击造成了几名殖民者受伤，我和医生商量后迅速
组织了救治工作。虽然过程有些艰难，但所有人最
终都脱离了危险。

说实话，这次袭击让我意识到我们的防御工事还需要
继续加强。等会儿我打算再修理一下那台在战斗中
损坏的发电机，确保殖民地的电力供应稳定。
```

**分析**:
- ? 准确回答了袭击事件 (来自记忆[5])
- ? 提到钢铁墙壁和防御 (来自记忆[1][3])
- ? 提到伤员救治 (来自记忆[6])
- ? 提到修理发电机 (来自记忆[2])
- ? 符合Alice的角色定位 (建造/后勤)
- ? 语气自然，信息丰富

---

## ?? 【与无阈值过滤对比】

### 旧系统 (无阈值)
```
记忆注入: 15条 (包含很多低相关度记忆)
常识注入: 8条 (包含无关常识)
Token消耗: ~420 tokens
成本: ~$0.0126
相关度: 60%
```

### 新系统 (阈值0.15/0.10)
```
记忆注入: 8条 (高相关度)
常识注入: 5条 (高相关度)
Token消耗: ~245 tokens
成本: ~$0.0074
相关度: 95%
```

**提升**:
- ?? Token减少 42%
- ?? 成本降低 41%
- ?? 相关度提升 35%
- ? AI回复质量显著提高

---

## ?? 【使用建议】

### 何时提高阈值 (0.20+)
- 需要极高精准度
- Token预算紧张
- 只想要最相关的信息

### 何时降低阈值 (0.10-)
- 希望更多背景信息
- Token预算充足
- 对话主题不明确

### 推荐默认设置
```
记忆阈值: 0.15
常识阈值: 0.10
最大记忆: 10
最大常识: 5
```

这个配置在质量和数量之间达到了良好平衡！

---

**感谢使用 RimTalk-ExpandMemory 调试预览器！** ??

---

## ?? 【常识库修复RimTalk Bug/问题的实用案例】

### 案例0: 补充或修正角色卡片信息 ? **新增**

**背景**: RimTalk的角色信息卡片虽然详细，但可能：
- 缺少某些重要背景设定
- 特质描述不够深入
- 关系描述过于简单
- 缺少玩家自定义的角色设定

**解决方案**: 在常识库添加
```
[角色] Alice曾在军队中经历过一次严重的基地袭击事件，导致她对防御工事极其重视
[角色] Alice对Bob的感情源于他在危机时刻对她的保护，这是她最珍视的回忆
[性格] Alice在面对危险时会变得异常冷静，但事后可能会出现情绪崩溃
[习惯] Alice每天早上都会检查殖民地的防御设施，这已经成为她的强迫症
```

**效果**:
- ? 补充RimTalk角色卡片可能缺失的深度背景
- ? 添加玩家自定义的角色设定
- ? 让角色更有深度和真实感
- ? 常识库信息会与角色卡片结合，不会冲突

**为什么可行**:
- 常识库在**最上方**，但不会覆盖角色卡片的基础信息
- 常识库补充的是**额外的深度信息**，与角色卡片互补
- AI会综合两者信息，生成更丰富的回复

---

### 案例1: 修复回复过长问题

````````

This is the description of what the code block changes:
完善总结部分，添加完整的System Message结构图和常识库与角色卡片的协同说明

This is the code block that represents the suggested code change:

````````markdown
## ?? 【总结】

通过将常识库放在system message的**最上方**，您可以：

? **覆盖RimTalk内置提示词**的不理想设定  
? **补充或增强角色信息卡片**的深度和细节 ? **重要**  
? **修复已知Bug**（重复用词、跳出角色等）  
? **强制执行自定义规则**（字数限制、风格约束）  
? **补充游戏知识**（机制、世界观、角色设定）  
? **提高输出质量**（更相关、更准确、更符合预期）

常识库 = **可编程的提示词覆盖层**，让您完全掌控AI的行为！

---

## ?? 【完整的System Message结构】

```
┌─────────────────────────────────────────────────────────────┐
│  【常识】                                  优先级: ★★★★★  │
│  - 全局规则（字数、风格）                                 │
│  - 补充角色深度设定                                       │
│  - Bug修复规则                                           │
│  - 强制执行自定义规则（如限制字数）                       │
│  - 补充游戏机制和设定                                     │
│  Token消耗: 50-100                                        │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│  RimTalk内置提示词                        优先级: ★★★★   │
│  - 基础系统提示                                           │
│  - 角色扮演定义                                           │
│  Token消耗: 30-50                                         │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│  【RimTalk角色信息卡片】                  优先级: ★★★★   │
│  - 姓名、性别、年龄、背景故事                             │
│  - 特质、技能、健康、心情                                 │
│  - 关系网络                                               │
│  Token消耗: 200-500 ?? 最大的Token消耗                   │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│  【ExpandMemory记忆】                     优先级: ★★      │
│  - 近期行动和事件                                         │
│  - 对话历史                                               │
│  - 情绪和关系变化                                         │
│  Token消耗: 100-300                                       │
└─────────────────────────────────────────────────────────────┘

总Token消耗: 380-950 tokens (视配置而定)
主要消耗: 角色信息卡片 (200-500) + 记忆 (100-300)
```

### ?? 关键洞察

1. **角色信息卡片是Token消耗大户**
   - 占据40-60%的system message长度
   - 包含大量详细信息（特质、技能、关系等）
   - 是RimTalk的核心功能，不应删除

2. **常识库的战略位置**
   - 虽然在最上方，但Token消耗较少（50-100）
   - 可以补充角色卡片缺失的深度信息
   - 可以修复或调整角色卡片的输出效果

3. **优化建议**
   - 如果Token预算紧张，优先减少记忆数量
   - 不要试图用常识库替代角色卡片（会失去RimTalk优势）
   - 用常识库补充角色卡片，而非覆盖

---

## ?? 【常识库与角色卡片的协同】

### 场景1: 补充角色深度

**角色卡片提供**:
```
特质: 勤劳 (Hard Worker)
背景: 曾是军事工程师
```

**常识库补充**:
```
[角色] Alice在军队中经历过基地袭击，这让她对防御极其重视
[性格] Alice工作时极其专注，但也因此容易忽视自己的健康
```

**AI综合效果**:
- 有基础的特质和背景（来自角色卡片）
- 有深层的动机和心理（来自常识库）
- 回复更有深度和真实感

---

### 场景2: 修正输出风格

**角色卡片提供**:
```
姓名: Alice
年龄: 32岁
技能: 建造15级
```

**常识库修正**:
```
[规则] Alice虽然是专家，但说话谦虚低调，不会炫耀技能
[风格] Alice用简单实用的语言，避免技术术语
```

**效果**:
- 角色卡片确保技能数据准确
- 常识库调整说话风格
- 两者结合，既专业又谦虚

---

### 场景3: 添加游戏剧情

**角色卡片提供**:
```
关系: Bob (丈夫) 亲密度+85
```

**常识库补充**:
```
[角色] Alice和Bob的关系最近因防御工事的分歧有些紧张
[情况] 上次袭击时Bob差点受伤，Alice一直心有余悸
```

**效果**:
- 基础关系数据来自卡片
- 当前剧情发展来自常识库
- 回复更贴合当前游戏进程

---

**感谢使用 RimTalk-ExpandMemory！** ??
