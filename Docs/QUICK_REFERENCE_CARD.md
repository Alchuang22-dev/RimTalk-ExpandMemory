# 常识库快速参考卡 - 修复RimTalk问题

## ?? 核心概念

**常识库位于system message最上方，可以覆盖RimTalk的内置提示词！**

```
注入顺序: 【常识】→ RimTalk提示词 → 【角色卡片】→ 【记忆】
优先级:    ★★★★★   →   ★★★★    →   ★★★★   →   ★★
Token消耗:  50-100  →    30-50    →  200-500  → 100-300
```

### ?? 重要提示

**RimTalk角色信息卡片**:
- ?? 包含角色的详细信息（背景、特质、技能、关系等）
- ?? 是Token消耗大户（200-500 tokens，占40-60%）
- ? 是RimTalk核心功能，**不应删除**
- ?? 常识库可以**补充**角色卡片，而非替代

---

## ?? 常用修复模板

### 0?? 补充角色深度 ? **推荐**
```
[角色] {姓名}的深层动机是{动机描述}
[性格] {姓名}在{情况}时会表现出{行为特征}
[习惯] {姓名}有个习惯是{习惯描述}
[背景] {姓名}的过去经历了{重要事件}，这影响了{性格/行为}
```
**示例**:
```
[角色] Alice曾在军队中经历过基地袭击，这让她对防御极其重视
[性格] Alice工作时极其专注，但也容易忽视自己的健康
[习惯] Alice每天早上都会检查殖民地的防御设施
[背景] Alice对Bob的感情源于他在危机时刻的保护
```
**效果**: 补充角色卡片深度 ??

---

### 1?? 限制回复长度
```
[规则] 所有回复必须控制在80字以内，简洁明了
[规则] 只回答用户的具体问题，不要主动延伸话题
```
**效果**: 节省60% Token ?

---

### 2?? 修复重复用词
```
[规则] 避免重复使用相同的词汇和句式，保持语言多样性
[禁止] 禁止在同一回复中多次使用"确实"、"的确"、"其实"等词
```
**效果**: 语言更自然 ?

---

### 3?? 强化角色性格
```
[角色] {姓名}的核心性格是{特征}
[风格] {姓名}说话时{风格描述}
[禁止] {姓名}不会{禁止行为}
```
**示例**:
```
[角色] Alice性格谨慎保守，做事三思而后行
[风格] Alice说话时多用"可能"、"也许"等词，避免绝对化
[禁止] Alice不会使用夸张或激进的表达方式
```
**效果**: 角色更鲜明 ??

---

### 4?? 防止跳出角色
```
[规则] 你永远是殖民者本人，不是AI助手
[禁止] 禁止提及"作为AI"、"我是语言模型"、"我无法体验"
[规则] 始终从角色第一人称视角回答，保持角色扮演
```
**效果**: 沉浸感更强 ??

---

### 5?? 修正游戏知识
```
[规则] 钢铁墙壁只能抵挡常规攻击，无法防御机械族穿甲弹
[规则] 太阳能板在夜间和日食期间完全无效
[规则] 殖民者每天需要6-8小时睡眠，否则会精神崩溃
```
**效果**: 知识更准确 ??

---

### 6?? 设置语言风格
```
[风格] 使用自然、口语化的表达，避免书面语和成语
[风格] 语气轻松随意，像朋友聊天一样
[禁止] 不使用"诚然"、"不亦乐乎"等古板词汇
```
**效果**: 对话更自然 ??

---

### 7?? 内容过滤
```
[规则] 所有内容必须适合全年龄，避免详细描述暴力场景
[规则] 不要描述血腥、残忍或不当的细节
[规则] 保持对话积极、建设性，避免过度消极情绪
```
**效果**: 内容更健康 ?

---

### 8?? 修复时间线混乱
```
[规则] 严格按照记忆中的时间顺序回答问题
[规则] 如果不确定事件发生时间，说"我记不太清了"而不是编造
[规则] 优先使用记忆中的明确时间标记
```
**效果**: 时间更准确 ?

---

### 9?? 禁止复述游戏Thoughts ? **常见问题**
```
[必须] 绝对禁止复述游戏的"想法"、"看法"、"心情修正"等机制内容
[必须] 绝对禁止使用括号数字如"(+5)"、"(-3)"的格式
[规则] 将游戏机制转化为自然的第一人称感受
[禁止] 禁止词汇："我的想法是"、"我的看法是"、"心情修正"、"buff"

[示例-错误] "我的想法：吃了美味的饭菜(+5)，房间很脏(-3)"
[示例-正确] "刚才那顿饭真不错！不过房间有点乱，得找时间打扫"
```
**效果**: 避免机械复述，保持沉浸感 ??

**详细方案**: 参见 `Docs\THOUGHTS_FILTER_SOLUTION.md`

---

## ?? 标签使用规范

| 标签 | 用途 | 示例 |
|------|------|------|
| `[规则]` | 必须遵守的规则 | `[规则] 回复控制在80字以内` |
| `[禁止]` | 禁止的行为 | `[禁止] 禁止使用"确实"` |
| `[必须]` | 必须执行的约束 | `[必须] 必须保持角色扮演` |
| `[角色]` | 角色性格设定 | `[角色] Alice谨慎保守` |
| `[风格]` | 语言风格要求 | `[风格] 口语化表达` |
| `[修复]` | 修复特定问题 | `[修复] 解决重复用词问题` |
| `[世界观]` | 世界观设定 | `[世界观] 这是边缘世界` |

---

## ?? 重要性设置建议

| 类型 | 重要性 | 说明 |
|------|--------|------|
| 核心规则 | 0.9 - 1.0 | 字数限制、角色扮演等 |
| 角色设定 | 0.7 - 0.9 | 性格、风格等 |
| 补充知识 | 0.5 - 0.7 | 游戏机制、世界观等 |
| 参考信息 | 0.3 - 0.5 | 次要背景信息 |

---

## ?? 快速开始

### Step 1: 打开常识库管理器
```
Mod设置 → RimTalk-ExpandMemory → 常识库管理
```

### Step 2: 添加基础规则（推荐）
```
[规则] 回复控制在80字以内，简洁明了
[规则] 避免重复使用相同的词汇和句式
[规则] 始终保持角色扮演，不要跳出角色
[风格] 使用自然、口语化的表达
```
重要性: **0.9**

### Step 3: 测试效果
```
Mod设置 → 打开调试预览器 → 选择殖民者 → 查看JSON
```

### Step 4: 根据需求调整
- 回复还是太长？提高字数限制的重要性到 **1.0**
- 角色不够鲜明？添加更详细的角色设定
- 发现新bug？添加针对性的修复规则

---

## ?? 使用技巧

### ? 推荐做法
- 保持5-10条核心规则
- 使用明确的标签（`[规则]`、`[禁止]`等）
- 设置合理的重要性（0.9为核心规则）
- 定期使用调试预览器测试
- 针对不同殖民者定制规则
- **用常识库补充角色卡片深度** ? **推荐**

### ? 避免陷阱
- ? 不要添加100条常识（太多了）
- ? 不要在常识中描述具体事件（用记忆）
- ? 不要写临时性信息（如"今天天气好"）
- ? 不要所有常识都设为1.0（失去层次）
- ? **不要试图用常识库替代角色卡片** ?? **重要**

### ?? 常识库的正确用途

**? 应该做的**:
1. 补充角色卡片的深度信息
2. 修复RimTalk的输出问题
3. 设置全局规则（字数、风格）
4. 添加当前剧情发展

**? 不应该做的**:
1. 重复角色卡片已有的信息
2. 删除或覆盖角色的基础属性
3. 添加与角色卡片冲突的信息

---

## ?? 效果对比

### 未使用常识库覆盖
```
用户: "你能做什么？"
AI: "当然可以！我可以做很多事情！确实，我擅长建造，
     确实也会烹饪，而且确实在研究方面也有涉猎。殖民地
     的很多工作都是我负责的，确实非常忙碌..." (140字)
```
? 太长、重复、冗长

### 使用常识库覆盖后
```
常识:
[规则] 回复控制在80字以内
[规则] 避免重复词汇

AI: "我擅长建造和烹饪，最近也在研究新技术。
     墙壁、防御工事这些都是我负责的。" (42字)
```
? 简洁、清晰、高效（节省70% Token）

---

## ?? 调试流程

```
1. 发现问题
   ↓
2. 打开常识库管理器
   ↓
3. 添加修复规则
   ↓
4. 打开调试预览器
   ↓
5. 查看JSON和注入顺序
   ↓
6. 测试实际对话
   ↓
7. 根据效果调整
```

---

## ?? 故障排查

### 问题: 常识库不生效
- ? 检查重要性是否足够高（建议0.9）
- ? 检查是否启用了该常识条目
- ? 使用调试预览器查看是否被注入
- ? 确认阈值设置（默认0.10）

### 问题: 回复还是太长
- ? 提高字数限制规则的重要性到1.0
- ? 添加更严格的规则: `[必须] 必须严格控制在50字以内`
- ? 添加禁止规则: `[禁止] 禁止主动延伸话题`

### 问题: 角色性格不明显
- ? 提高角色设定的重要性（0.8-0.9）
- ? 添加更详细的性格描述
- ? 添加具体的行为约束: `[禁止] Alice不会说脏话`

### 问题: Token消耗太高
- ? **理解**: 角色卡片占40-60% Token（200-500）
- ? **优先**: 减少记忆数量（从10减到5）
- ? **提高**: 记忆和常识的阈值（0.15→0.20）
- ? **保留**: 角色卡片是RimTalk核心，不要删除
- ? **避免**: 不要用常识库替代角色卡片

---

## ?? 【Token消耗分析】

### System Message组成

| 组件 | Token消耗 | 占比 | 可优化程度 |
|------|----------|------|-----------|
| 常识库 | 50-100 | 10-15% | ? 高 (可控制数量) |
| RimTalk提示 | 30-50 | 5-8% | ? 低 (核心功能) |
| **角色卡片** | **200-500** | **40-60%** | ? **不可删** |
| 记忆 | 100-300 | 20-35% | ? 高 (可控制数量) |
| **总计** | **380-950** | **100%** | - |

### 优化策略

**如果Token预算紧张**:

1. **首选**: 减少记忆数量
   ```
   maxInjectedMemories: 10 → 5
   节省: ~100 tokens (26%)
   ```

2. **次选**: 提高阈值
   ```
   memoryScoreThreshold: 0.15 → 0.20
   knowledgeScoreThreshold: 0.10 → 0.15
   节省: ~50 tokens (13%)
   ```

3. **保留**: 角色卡片
   ```
   ? 不要删除或简化
   ? 这是RimTalk的核心价值
   ? 200-500 tokens是必要的投入
   ```

4. **精简**: 常识库
   ```
   保持5-10条核心规则
   节省: ~30 tokens (8%)
   ```

### ?? Token效益比

| 投入 | 收益 | 效益比 |
|------|------|--------|
| 角色卡片 (300 tokens) | 详细角色信息 | ????? 极高 |
| 记忆 (150 tokens) | 上下文相关性 | ???? 高 |
| 常识库 (70 tokens) | 规则和深度 | ???? 高 |
| RimTalk提示 (40 tokens) | 基础功能 | ??? 中 |

**结论**: 所有组件都有高价值，优化应该是"精简"而非"删除"

---

## ?? 实战示例

### 场景: 修复Alice总是说"确实"的问题

**Step 1**: 添加常识
```
[规则] 避免重复使用"确实"、"的确"等词汇
[禁止] 同一回复中不要出现2次以上相同词汇
[风格] 使用多样化的表达，如"是的"、"没错"、"对"
```
重要性: **0.9**

**Step 2**: 测试效果
```
调试预览器 → 查看JSON:
  【常识】              ← 在最上方！
  [规则] 避免重复使用"确实"...
  
  RimTalk提示词
  
  【记忆】
```

**Step 3**: 实际对话测试
```
修复前: "确实，这确实是个问题，确实需要解决"
修复后: "是的，这个问题需要尽快解决"
```
? 成功！

---

## ?? 参考资料

- **完整文档**: `Docs\KNOWLEDGE_PRIORITY_UPDATE.md`
- **优化说明**: `Docs\INJECTION_OPTIMIZATION_v2.3.md`
- **测试示例**: `Docs\TEST_JSON_SIMULATION.md`

---

## ?? 总结

**常识库 = 可编程的提示词覆盖层**

通过将常识库放在最上方，您可以：
- ?? 修复RimTalk的bug
- ? 优化Token消耗
- ?? 强化角色性格
- ?? 修正游戏知识
- ?? 提高沉浸感

**立即开始**: Mod设置 → 添加5条核心规则 → 打开调试预览器测试！

---

**打印此卡片，随时参考！** ??
