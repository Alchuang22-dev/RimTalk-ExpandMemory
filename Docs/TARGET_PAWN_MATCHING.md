# ?? 工作对象匹配功能 - 使用说明

## ? 新功能

**现在常识库可以匹配工作对象/交互对象的信息了！**

---

## ?? 功能说明

### 支持的场景

| 场景 | 当前角色 | 目标角色 | 匹配效果 |
|------|---------|---------|---------|
| 对话 | 说话者 | 听众 | ? 匹配双方信息 |
| 喂食囚犯 | 喂食者 | 囚犯 | ? 匹配囚犯的年龄/种族 |
| 治疗他人 | 医生 | 病人 | ? 匹配病人状态 |
| 照顾婴儿 | 照顾者 | 婴儿 | ? 匹配婴儿年龄段 |

---

## ?? 工作原理

### 关键词提取流程

```
1. 提取上下文关键词
   ├─ 从对话内容中提取
   └─ 或使用角色名作为种子

2. 提取当前角色关键词
   ├─ 名字、年龄、性别、种族
   ├─ 特质、技能、健康状况
   └─ 关系网络、背景故事

3. 提取目标角色关键词（新增！）?
   ├─ 同样提取所有信息
   ├─ 添加到关键词池
   └─ 用于匹配常识

4. 常识匹配
   ├─ 使用综合关键词池
   ├─ 计算Jaccard相似度
   ├─ 添加匹配数量加分
   └─ 按评分排序注入
```

---

## ?? 实战示例

### 示例1：喂食婴儿囚犯

**场景**：
```
Alice（成人女性）给Bob（婴儿囚犯）喂食
```

**提取的关键词**：
```
当前角色（Alice）:
- Alice, 成人, 女性, 人类
- 建造15级, 专家, 精通
- 健康, 良好

目标角色（Bob）:
- Bob, 婴儿, 宝宝, baby  ? 新增！
- 男性, 人类
- 囚犯  ? 新增！
```

**可匹配的常识**：
```
? [规则] 婴儿不会说话
   关键词: 婴儿, 宝宝, baby
   匹配: Bob的"婴儿"关键词 ?
   
? [行为] 对待囚犯要小心
   关键词: 囚犯, 监狱, 小心
   匹配: Bob的"囚犯"关键词 ?
   
? [角色] Alice擅长照顾他人
   关键词: Alice, 照顾, 护理
   匹配: Alice的名字
```

**之前**：只能匹配Alice，不能匹配婴儿和囚犯
**现在**：可以匹配双方信息！?

---

### 示例2：治疗受伤的老人

**场景**：
```
医生Charlie治疗受伤的老人David
```

**提取的关键词**：
```
当前角色（Charlie）:
- Charlie, 成人, 男性
- 医疗18级, 专家
- 健康

目标角色（David）:
- David, 老人, 成人  ?
- 受伤, 伤势  ?
- 恢复中  ?
```

**可匹配的常识**：
```
? [医疗] 老人恢复速度较慢
   匹配: David的"老人"+"恢复中"
   
? [医疗] 受伤的人需要休息
   匹配: David的"受伤"+"伤势"
```

---

### 示例3：与青少年对话

**场景**：
```
Alice与青少年Emma交谈
```

**提取的关键词**：
```
当前角色（Alice）:
- Alice, 成人, 女性

目标角色（Emma）:
- Emma, 青少年, teenager  ?
- 女性
```

**可匹配的常识**：
```
? [沟通] 与青少年说话要耐心
   关键词: 青少年, teenager, 耐心
   匹配: Emma的"青少年"
   
? [性格] 青少年容易情绪化
   匹配: Emma的"青少年"
```

---

## ?? 常识编写建议

### ? 推荐做法

#### 1. 使用宽泛的对象关键词

```
? 好的写法:
[规则] 婴儿不会说话，需要特殊照顾
关键词: 婴儿, 宝宝, baby, 照顾, 护理

效果: 无论谁照顾婴儿，都能匹配
```

```
? 不好的写法:
[规则] Alice照顾婴儿时要注意
关键词: Alice, 婴儿

问题: 只能匹配Alice，其他人照顾婴儿时无法匹配
```

#### 2. 添加对象类型关键词

```
? 婴儿相关:
关键词: 婴儿, 宝宝, baby, 新生儿, 幼儿

? 囚犯相关:
关键词: 囚犯, 犯人, 监狱, 牢房, prisoner

? 老人相关:
关键词: 老人, 长者, 年长, 老年, elder

? 青少年相关:
关键词: 青少年, 少年, teenager, 年轻
```

#### 3. 结合场景关键词

```
[医疗] 治疗受伤的婴儿需要极度小心
关键词: 婴儿, 受伤, 治疗, 医疗, 小心, 谨慎

匹配场景:
- 当前角色: 医生（医疗技能）
- 目标角色: 婴儿 + 受伤状态
```

---

### ? 避免的陷阱

#### 1. 过度具体化

```
? 错误:
[规则] Alice给Bob喂食时要注意他是婴儿
关键词: Alice, Bob, 喂食, 婴儿

问题: 只匹配特定的Alice和Bob组合
```

```
? 正确:
[规则] 给婴儿喂食时要注意温度和量
关键词: 婴儿, 宝宝, 喂食, 照顾, 温度

效果: 任何人给任何婴儿喂食都能匹配
```

#### 2. 忽略同义词

```
? 不完整:
[规则] 婴儿需要特殊照顾
关键词: 婴儿

问题: 如果游戏使用"宝宝"或"baby"，可能无法匹配
```

```
? 完整:
[规则] 婴儿需要特殊照顾
关键词: 婴儿, 宝宝, baby, 小宝, 新生儿, 幼儿

效果: 覆盖所有可能的表达方式
```

---

## ?? 常见场景配置

### 场景1：婴儿照顾

```
[规则] 婴儿不会说话，只能咿呀学语
关键词: 婴儿, 宝宝, baby, 小宝, 新生儿
重要性: 0.9

[规则] 婴儿需要频繁喂食和换尿布
关键词: 婴儿, 宝宝, 喂食, 照顾, 护理
重要性: 0.8

[行为] 对婴儿要格外温柔和耐心
关键词: 婴儿, 温柔, 耐心, 照顾
重要性: 0.7
```

### 场景2：囚犯管理

```
[规则] 囚犯可能企图逃跑或暴动
关键词: 囚犯, 犯人, 监狱, 逃跑, 暴动
重要性: 0.9

[行为] 与囚犯交流时保持警惕
关键词: 囚犯, 交流, 警惕, 小心
重要性: 0.8

[禁止] 不要完全信任囚犯的话
关键词: 囚犯, 信任
重要性: 0.7
```

### 场景3：老人护理

```
[医疗] 老人恢复速度比年轻人慢
关键词: 老人, 长者, 恢复, 治疗, 缓慢
重要性: 0.8

[行为] 对老人要尊重和耐心
关键词: 老人, 尊重, 耐心
重要性: 0.7
```

### 场景4：青少年沟通

```
[沟通] 青少年容易情绪化，需要耐心引导
关键词: 青少年, teenager, 情绪, 耐心
重要性: 0.8

[禁止] 不要用命令的语气对青少年说话
关键词: 青少年, 命令, 语气
重要性: 0.7
```

---

## ?? 技术细节

### API变更

**之前**：
```csharp
string InjectKnowledgeWithDetails(
    string context, 
    int maxEntries, 
    out List<KnowledgeScore> scores, 
    Verse.Pawn currentPawn = null
)
```

**现在**：
```csharp
string InjectKnowledgeWithDetails(
    string context, 
    int maxEntries, 
    out List<KnowledgeScore> scores, 
    Verse.Pawn currentPawn = null,
    Verse.Pawn targetPawn = null  // ?? 新增！
)
```

### 调用示例

```csharp
// 场景1：对话场景
var knowledgeContext = library.InjectKnowledgeWithDetails(
    conversationContext,
    maxEntries: 5,
    out scores,
    currentPawn: speaker,    // 说话者
    targetPawn: listener     // 听众 ?
);

// 场景2：单人场景（治疗、喂食等）
var knowledgeContext = library.InjectKnowledgeWithDetails(
    actionContext,
    maxEntries: 5,
    out scores,
    currentPawn: actor,      // 行动者
    targetPawn: target       // 目标对象 ?
);

// 场景3：无目标场景
var knowledgeContext = library.InjectKnowledgeWithDetails(
    context,
    maxEntries: 5,
    out scores,
    currentPawn: pawn,
    targetPawn: null         // 无目标
);
```

---

## ?? 效果对比

### 之前（只匹配当前角色）

```
场景: Alice喂食婴儿Bob

提取关键词: Alice, 成人, 女性, 建造15级, 专家

匹配常识:
? [角色] Alice擅长建造
? [规则] 婴儿不会说话 (无法匹配！)
? [行为] 照顾婴儿要温柔 (无法匹配！)
```

### 现在（匹配双方）

```
场景: Alice喂食婴儿Bob

提取关键词: 
- Alice, 成人, 女性, 建造15级, 专家
- Bob, 婴儿, 宝宝, baby, 男性  ? 新增！

匹配常识:
? [角色] Alice擅长建造 (匹配Alice)
? [规则] 婴儿不会说话 (匹配Bob的"婴儿") ?
? [行为] 照顾婴儿要温柔 (匹配Bob的"婴儿") ?
```

**提升**：匹配率提升200%！

---

## ?? 总结

### 新功能优势

? **更精准的常识匹配**
- 同时考虑行动者和目标对象
- 婴儿、囚犯、老人等特殊对象可以被正确识别

? **更丰富的交互上下文**
- 对话时匹配双方信息
- 工作时匹配工作对象信息

? **更自然的AI回复**
- AI可以了解交互对象的特征
- 根据对象调整说话方式

### 使用建议

1. **编写常识时考虑对象**
   - 添加对象类型关键词（婴儿、囚犯等）
   - 使用宽泛的表达，不要过度具体化

2. **添加同义词**
   - 婴儿：宝宝、baby、小宝、新生儿
   - 囚犯：犯人、prisoner、监狱

3. **测试验证**
   - 使用调试预览器查看关键词提取
   - 确认常识是否被正确匹配

---

**现在开始体验工作对象匹配功能吧！** ??
