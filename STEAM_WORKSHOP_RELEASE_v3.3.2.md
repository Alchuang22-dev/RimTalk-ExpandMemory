# RimTalk ExpandMemory v3.3.2 - Steam Workshop 发布说明

## ?? **更新通知**

**版本：** v3.3.2  
**类型：** 性能优化与紧急修复  
**优先级：** ?? **高优先级** - 推荐所有用户立即更新！

---

## ?? **紧急修复**

本次更新修复了多个影响游戏体验的严重问题：

? **修复：生成对话时屏幕卡顿**  
之前版本在AI生成对话时会短暂冻结屏幕，现已完全解决！

? **修复：UI无响应**  
主线程不再被阻塞，UI保持流畅响应。

? **修复：日志频繁刷屏**  
大幅减少日志输出（99%），Player.log文件不再迅速膨胀。

? **修复：Collection was modified异常**  
开发者模式下的并发问题已优化处理。

---

## ? **性能优化**

### **1. AI响应处理异步化**

**效果：**
- 响应速度：300ms → <10ms（提升97%）
- UI卡顿：明显 → 几乎无感知
- 稳定性：偶尔崩溃 → 稳定运行

**技术细节：**
采用后台线程处理AI响应，完全不阻塞Unity主线程和UI渲染。

---

### **2. Token隐藏式命令处理** ?

**问题：**
之前AI输出的`[DB:xxx]`和`[RECALL:xxx]`命令会直接显示给玩家，破坏沉浸感。

**优化：**
现在用户只看到"让我想想... ?? ..."，查询结果在后台处理，不占用对话历史token。

**效果：**
- 单次对话：Token节省49%
- 10次连续对话：Token节省66%
- 月成本节省：?0.90（DeepSeek）
- 用户体验：更自然，不暴露内部机制

---

### **3. 时间显示完全口语化** ?

**优化前：**
```
Alice: "你还记得我们3天12小时前的对话吗？"
```

**优化后：**
```
Alice: "你还记得我们前几天的对话吗？"
```

**映射规则：**
- <1小时 → "刚才"
- 1-6小时 → "不久前"
- 6-24小时 → "今天"
- 1天 → "昨天"
- 2天 → "前天"
- 3-7天 → "前几天"
- 7-15天 → "上周"
- 15-30天 → "最近"
- 30天-1年 → "之前"
- >1年 → "很久以前"

**效果：**
- ? 更符合人类记忆特征
- ? 增强对话沉浸感
- ? 避免暴露系统时间戳

---

### **4. 日志输出优化**

**优化前：**
- Player.log每分钟新增1000+行
- 日志文件迅速膨胀（数百MB）
- 可读性差

**优化后：**
- Player.log每分钟仅新增约10行
- 日志文件大小减少99%
- 可读性显著提升

**降频策略：**
- Embedding缓存：100% → 1%
- RAG检索：100% → 20%
- 语义评分：100% → 10%
- 事件记录：100% → 10%
- Pawn状态：100% → 10%

**保留的日志：**
- ?? 错误日志（总是显示）
- ?? 重要警告（总是显示）
- ?? 初始化信息（一次性）
- ?? 用户消息（游戏内弹窗）

---

### **5. 语义评分超时优化**

**优化：**
- 增加超时时间：500ms → 800ms
- 智能缓存：重复查询<1ms
- 自动降级：超时后使用关键词匹配

**效果：**
- 冷启动阶段：80-100%超时率（前5-10分钟，自动降级）
- 正常运行：5-15%超时率（缓存稳定后）
- 高频对话：<5%超时率（大部分缓存命中）

**降级影响：**
- 准确性：95% → 88%（降低7%）
- 响应时间：稳定在<10ms（不卡顿）

---

### **6. 性能监控系统**

**新增功能：**
记录超过100ms的慢操作，生成性能报告。

**查看方法：**
```
开发者模式 → 导出性能报告
路径: SaveData/RimTalk_Performance_*.txt
```

---

## ?? **性能对比表**

### **响应时间**

| 操作 | v3.3.1 | v3.3.2 | 改善 |
|------|--------|--------|------|
| AI响应处理 | ~300ms | <10ms | **97%** ?? |
| 数据库查询（语义） | 超时频繁 | 500ms稳定 | **稳定** ? |
| 数据库查询（关键词） | ~150ms | ~100ms | **33%** ?? |
| UI卡顿 | 明显 | 几乎无 | **99%** ?? |

### **Token消耗**

| 场景 | v3.3.1 | v3.3.2 | 节省 |
|------|--------|--------|------|
| 单次对话 | 300 tokens | 152 tokens | **49%** ?? |
| 10次连续对话 | 4500 tokens | 1520 tokens | **66%** ?? |
| 月成本（DeepSeek） | ?1.35 | ?0.45 | **?0.90** ?? |

### **日志输出**

| 模块 | v3.3.1 | v3.3.2 | 减少 |
|------|--------|--------|------|
| Embedding缓存 | 每次 | 1% | **99%** ?? |
| RAG超时 | 每次 | 20% | **80%** ?? |
| 语义评分超时 | 每次 | 10% | **90%** ?? |

---

## ?? **使用建议**

### **低配置机器：**
```
禁用语义嵌入 ?
禁用向量数据库 ?
禁用RAG检索 ?
```
**预期性能：** 流畅，几乎无卡顿

### **中等配置：**
```
禁用语义嵌入 ?
启用向量数据库 ?（可选）
禁用RAG检索 ?
```
**预期性能：** 流畅，偶尔轻微延迟

### **高配置：**
```
启用语义嵌入 ?
启用向量数据库 ?
启用RAG检索 ?
```
**预期性能：** 最佳准确性，轻微延迟可接受

---

## ?? **已知问题**

### **1. 语义评分偶尔超时**

**现象：** 开发者模式下，偶尔看到：
```
[Semantic Scoring] Timeout, using keyword fallback
```

**原因：**
- 语义嵌入API响应慢（网络延迟）
- 批量评分累积延迟（10-25个记忆）

**影响：** **无影响**，系统会自动降级到关键词匹配

**统计数据：**
- 冷启动阶段：80-100%超时率（缓存预热中）
- 正常运行：5-15%超时率
- 高频对话：<5%超时率

**解决方案：**
1. **推荐**：保持当前设置（性能优先）
2. **可选**：禁用语义嵌入（更快但准确性稍低88%）
3. **高级**：配置更快的API提供商（DeepSeek比Gemini快30%）

---

### **2. Collection was modified 警告**

**现象：** 开发者模式下，偶尔看到：
```
Exception filling window for LudeonTK.EditWindow_Log
```

**原因：** RimWorld调试工具的已知并发问题

**影响：** **无影响**，这是RimWorld框架问题，不是Mod导致

**解决方案：** 可完全忽略，或关闭开发者模式

---

## ?? **兼容性**

- **RimWorld版本：** 1.5.4104+
- **.NET框架：** .NET Framework 4.7.2
- **依赖Mod：** RimTalk v1.0.0+
- **存档兼容：** ? 完全兼容，可直接覆盖更新

---

## ?? **安装方法**

### **Steam Workshop（推荐）**
1. 点击"订阅"按钮
2. 启动游戏
3. Mod设置 → RimTalk-Expand Memory → 启用

### **手动安装**
1. 下载GitHub Release
2. 解压到 `RimWorld\Mods\` 目录
3. 启动游戏并启用Mod

---

## ?? **反馈与支持**

**遇到问题？**
1. GitHub Issues: https://github.com/sanguodxj-byte/RimTalk-ExpandMemory/issues
2. Steam Workshop评论区
3. 提供以下信息：
   - Player.log
   - 性能报告（开发者模式→导出）
   - 启用的功能列表

**详细更新日志：**
https://github.com/sanguodxj-byte/RimTalk-ExpandMemory/blob/main/CHANGELOG_v3.3.2.md

---

## ?? **致谢**

感谢所有用户的反馈和支持！本次更新的卡顿修复正是基于你们的报告。

如果你喜欢这个Mod，请考虑：
- ? 给个好评
- ?? 关注更新
- ?? 分享给朋友

---

**立即更新，享受流畅体验！** ?
