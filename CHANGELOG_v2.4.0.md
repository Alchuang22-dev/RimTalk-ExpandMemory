# 更新日志 - v2.4.0

## ?? 发布日期
2024-01-XX

## ?? 本次更新重点

### 1. 常识库系统增强

#### 导出导入格式支持重要性
**新格式**：
```
[标签|重要性]内容
[规则|0.9]回复控制在80字以内
[殖民者名单|0.85]成员：沙狐、白虎、黑熊
```

**兼容性**：
- ? 完全兼容旧格式 `[标签]内容`（自动设置为0.5）
- ? 支持纯文本导入（自动设置标签"通用"，重要性0.5）

**使用方法**：
1. 打开常识库管理器
2. 点击"导出"保存当前常识（包含重要性）
3. 编辑文本文件，可手动调整重要性
4. 点击"导入"重新加载

---

### 2. 智能内容匹配系统

#### 问题背景
旧版本使用2-4字分词，导致大量无意义词组：
```
"美狐在使用灵能" → 美狐?, 狐在?, 在使?, 使用?, 用灵?, 灵能?
```

#### 新方案
- ? **移除无意义分词**
- ? **直接内容匹配**：使用`Contains`匹配关键词
- ? **双重匹配机制**：标签匹配（粗分类） + 内容匹配（精确匹配）

#### 效果对比

**场景**：`[美狐,身体特征]有可爱的狐耳和蓬松的大尾巴`

| 方案 | 关键词 | 匹配结果 | 准确率 |
|------|--------|---------|--------|
| 旧版 | 美狐, 狐在, 在使, 使用 | 50%无意义 | ??? |
| 新版 | 美狐, 尾巴, 狐耳 | 100%有意义 | ????? |

---

### 3. 自动生成Pawn状态常识 ? **全新功能**

#### 功能说明
系统自动检测殖民者加入时间，生成状态常识，防止新人错误谈论不属于他们的经历。

#### 状态分级

| 天数 | 状态 | 重要性 | 示例 |
|------|------|--------|------|
| <1 | 新成员 | 0.95 | Alice是今天刚加入的新成员，对这里还很陌生 |
| 1-3 | 新成员 | 0.95 | Alice是2天前加入的新成员，刚开始熟悉殖民地 |
| 3-7 | 适应期 | 0.90 | Alice已经5天了，还在适应，对过往不太了解 |
| 7-15 | 融入期 | 0.85 | Alice已经10天，开始融入，但对早期历史不清楚 |
| 15-30 | 正式成员 | 0.80 | Alice已经是一员（25天），熟悉最近的事 |
| 30-60 | 成员 | 0.70 | Alice生活了45天，了解最近一个月的事件 |
| 60+ | 老成员 | 0.60 | Alice是老成员（75天），见证了发展历程 |

#### 效果演示

**没有状态常识**：
```
新人Alice（加入3天）对老成员Bob说：
"还记得我们去年一起建造防御墙的时候吗？"
? 错误：Alice才来3天，不可能有"去年"的记忆
```

**有状态常识**：
```
注入常识：
[Alice,状态|0.95]Alice是3天前加入的新成员，不了解之前的事情

Alice回复：
"Bob，我刚来不久，还不太了解殖民地以前的事情。能跟我讲讲吗？"
? 正确：符合新成员身份
```

#### 使用方法

**自动模式**（推荐）：
- 默认启用，无需手动操作
- 系统每小时自动更新所有殖民者状态
- 重要性随时间自动递减

**手动关闭**：
```
Mod设置 → RimTalk-ExpandMemory → 记忆类型 
→ 取消勾选"自动生成新人/老人状态常识"
```

---

## ?? 技术细节

### 文件变更

#### 新增文件
- `Source/Memory/PawnStatusKnowledgeGenerator.cs` - Pawn状态常识生成器

#### 修改文件
- `Source/Memory/CommonKnowledgeLibrary.cs`
  - `FormatForExport()` - 增加重要性导出
  - `ParseLine()` - 支持解析重要性
  - `CalculateRelevanceScore()` - 优化匹配算法

- `Source/Memory/MemoryManager.cs`
  - `WorldComponentTick()` - 添加状态常识自动更新

- `Source/RimTalkSettings.cs`
  - 添加 `enablePawnStatusKnowledge` 开关
  - 添加 UI 配置项

### API 变更

**无破坏性变更**
- ? 完全向后兼容
- ? 旧格式常识库正常工作
- ? 新功能可选（可关闭）

---

## ?? Bug 修复

1. **修复无意义分词问题**
   - 问题：提取"狐在"、"在使"等无意义词组
   - 解决：移除分词，使用直接匹配

2. **修复新人时间线混乱**
   - 问题：新人错误谈论不属于自己的经历
   - 解决：自动生成状态常识，明确身份

3. **优化匹配准确率**
   - 问题：关键词匹配不精确
   - 解决：双重匹配机制（标签+内容）

---

## ?? 性能影响

- ? **内存**：新增状态常识约 15 bytes/人
- ? **CPU**：每小时检查一次，影响可忽略
- ? **Token**：每个状态常识约 15-25 tokens

---

## ?? 用户体验改进

1. **常识库更易分享**
   - 导出包含重要性
   - 复制粘贴即可使用

2. **新人对话更自然**
   - 自动识别身份
   - 不会越俎代庖

3. **匹配更精确**
   - 减少无意义匹配
   - 提高相关性

---

## ?? 使用建议

### 小型殖民地（3-10人）

**推荐配置**：
```
[殖民者名单|0.90]成员：沙狐(美狐族)、白虎(人类)、黑熊(人类)、Alice、Bob
[规则|0.95]回复控制在80字以内
[规则|0.90]始终保持角色扮演
[美狐族|0.80]美狐族注重清洁，厌恶脏乱
```

**状态常识**：
- 自动生成（推荐）
- 或手动添加针对性常识

### 大型殖民地（10+人）

**推荐配置**：
```
# 只标注容易混淆的名字
[白虎|0.80]白虎是人类殖民者，不是动物
[黑熊|0.80]黑熊是人类殖民者，不是动物
[金狐|0.80]金狐是美狐族殖民者，不是动物

# 核心规则
[规则|0.95]回复控制在80字以内
[规则|0.90]所有名字都是殖民者，不是真实动物
```

**状态常识**：
- 必须启用自动生成
- 人多难以手动维护

---

## ?? 未来计划

- [ ] 支持自定义状态描述模板
- [ ] 添加关系记忆（友好/敌对）
- [ ] 支持情绪状态常识
- [ ] 添加技能成长记录

---

## ?? 反馈与支持

- **GitHub Issues**: https://github.com/sanguodxj-byte/RimTalk-ExpandMemory/issues
- **Steam Workshop**: [链接]

---

## ?? 相关文档

- [常识库快速参考卡](Docs/QUICK_REFERENCE_CARD.md)
- [完整文档](Docs/KNOWLEDGE_PRIORITY_UPDATE.md)
- [优化说明](Docs/INJECTION_OPTIMIZATION_v2.3.md)

---

## ?? 致谢

感谢所有提供反馈和建议的用户！

---

**版本**: v2.4.0  
**兼容性**: RimWorld 1.4, 1.5  
**依赖**: RimTalk (可选)
