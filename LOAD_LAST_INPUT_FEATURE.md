# ?? v2.4.3 更新：读取RimTalk上次输入

## ? 新功能概览

在**注入预览器**的上下文输入框旁边，新增了**"读取上次输入 ??"**按钮，可以自动从RimTalk读取最后一次发送给AI的对话内容。

---

## ?? 功能特点

### 1?? 自动读取最后对话
- ? 一键读取RimTalk最后一次请求的完整上下文
- ? 包括用户输入的对话内容、话题等
- ? 100%重现实际发送给AI的内容

### 2?? 智能角色切换
- ? 自动切换到对应的殖民者
- ? 无需手动查找是谁在对话
- ? 保持上下文一致性

### 3?? 时间追踪
- ? 显示距离上次对话的时间
- ? 精确到"刚刚"、"X分钟前"、"X小时前"、"X天前"
- ? 帮助理解对话的时效性

---

## ?? 使用说明

### 基础用法

```
步骤1: 在游戏中进行一次RimTalk对话
       （让殖民者用RimTalk生成一段对话）

步骤2: 打开注入预览器
       （Mod设置 → 调试工具 → 打开注入内容预览器）

步骤3: 点击"读取上次输入 ??"按钮
       （位于上下文输入框右侧）

步骤4: 查看预览结果
       （预览器显示与RimTalk实际发送完全相同的注入内容）
```

### 高级用法

#### 场景1：调试为什么AI生成了某段对话
```
问题: "为什么Alice突然提到了防御工事？"

解决:
1. 点击"读取上次输入"
2. 查看预览器显示的注入记忆
3. 发现有一条"讨论了防御工事"的记忆被注入
4. 理解了AI为什么会那样回答
```

#### 场景2：对比不同上下文的注入效果
```
测试1: 点击"读取上次输入"（实际对话上下文）
结果1: 注入了3条记忆 + 2条常识

测试2: 清空上下文（纯净评分）
结果2: 注入了2条记忆 + 1条常识

对比: 了解关键词匹配的影响
```

#### 场景3：验证修改后的效果
```
1. 修改记忆阈值从0.15→0.10
2. 点击"读取上次输入"
3. 对比修改前后注入的记忆数量
4. 调整到满意为止
```

---

## ?? 界面说明

### 按钮位置
```
┌──────────────────────────────────────────────────────────┐
│ 上下文输入：                     [读取上次输入 ??]      │
│ ┌────────────────────────────────────────────────────┐  │
│ │ （这里显示读取到的对话内容）                        │  │
│ │                                                     │  │
│ └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

### 工具提示（悬停查看）
```
从RimTalk读取最后一次发送给AI的对话内容
（仅当RimTalk已安装且有对话记录时可用）
```

### 成功消息
```
? 已加载 Alice 的最后一次对话（5分钟前）
```

### 错误消息
```
? 未找到RimTalk的最近对话记录
   （可能原因：游戏刚加载，还没有对话记录）
```

---

## ?? 使用提示

### 提示1：何时使用
- ? 调试RimTalk对话效果时
- ? 验证记忆注入是否正确时
- ? 对比不同设置的效果时
- ? 理解为什么AI生成特定回答时

### 提示2：注意事项
- ?? 只保存最后一次请求（不是历史记录）
- ?? 需要先进行至少一次RimTalk对话
- ?? 重新加载游戏后需要重新对话

### 提示3：配合使用
```
读取上次输入  →  查看注入内容  →  调整设置  →  再次对话  →  验证效果
      ↑                                                        ↓
      └────────────────────── 循环优化 ──────────────────────┘
```

---

## ?? 实际案例

### 案例1：新手调试

**问题**：不知道常识库是否生效

```
1. 在常识库添加：[规则] 回复控制在80字以内
2. 让Alice与Bob对话
3. 点击"读取上次输入"
4. 查看"常识注入"部分
   → 看到[规则]常识被注入 ?
5. 确认常识库正常工作
```

### 案例2：优化记忆阈值

**目标**：找到最佳记忆阈值

```
当前设置：阈值0.20

1. Alice与Bob讨论防御
2. 点击"读取上次输入"
3. 发现只注入了1条记忆（太少）

调整：阈值0.20 → 0.15

4. 点击"刷新预览"
5. 现在注入了3条记忆（合适）?
6. 保存设置
```

### 案例3：理解关键词匹配

**问题**：为什么某条记忆总是被注入？

```
1. 点击"读取上次输入"
2. 查看对话内容："我们需要更多食物"
3. 查看注入记忆：
   - [对话] Alice今天烹饪了美味的食物 (评分0.68)
     └─ 关键词匹配：0.32 ← 匹配"食物"！

明白了：因为关键词"食物"匹配，所以这条记忆被注入
```

---

## ?? 技术细节

### 缓存机制
```csharp
// 每次RimTalk调用GetMemoryPrompt时自动缓存
public static string GetMemoryPrompt(Pawn pawn, string basePrompt)
{
    // ? 自动缓存
    lastRimTalkContext = basePrompt;
    lastRimTalkPawn = pawn;
    lastRimTalkTick = Find.TickManager.TicksGame;
    
    // ...正常处理...
}
```

### 读取方式
```csharp
// 预览器通过API读取
string context = RimTalkMemoryAPI.GetLastRimTalkContext(
    out Pawn lastPawn,   // 谁在对话
    out int lastTick     // 什么时间
);
```

### 时间计算
```csharp
int ticksAgo = currentTick - lastTick;
string timeAgo = 
    ticksAgo < 60 ? "刚刚" : 
    ticksAgo < 2500 ? $"{ticksAgo / 60}分钟前" : 
    ticksAgo < 60000 ? $"{ticksAgo / 2500}小时前" : 
    $"{ticksAgo / 60000}天前";
```

---

## ?? 常见问题

### Q1: 点击按钮后提示"未找到记录"？
**A**: 需要先让RimTalk生成至少一次对话，然后再点击按钮。

### Q2: 读取到的内容与实际不符？
**A**: 缓存只保存最后一次请求，确认是否有其他对话覆盖了它。

### Q3: 可以查看历史记录吗？
**A**: 目前只保存最后一次，未来版本可能加入历史记录功能。

### Q4: 手动输入的上下文会被覆盖吗？
**A**: 不会，点击"读取上次输入"才会替换，手动输入不受影响。

### Q5: 需要RimTalk mod吗？
**A**: 是的，此功能依赖RimTalk的对话系统，没有RimTalk无法使用。

---

## ?? 功能对比

| 特性 | v2.4.2（旧版） | v2.4.3（新版） |
|------|---------------|---------------|
| 上下文输入 | ? 手动输入 | ? 手动输入 |
| 读取RimTalk | ? 不支持 | ? **一键读取** |
| 角色切换 | ?? 手动选择 | ? **自动切换** |
| 时间显示 | ? 无 | ? **精确显示** |
| 重现度 | ?? 近似 | ? **100%准确** |

---

## ?? 总结

**v2.4.3 新增的"读取上次输入"功能**让你可以：

1. ? **完美重现**：100%重现RimTalk实际发送的内容
2. ? **调试神器**：快速找到对话异常的原因
3. ? **优化助手**：对比不同设置的效果
4. ? **学习工具**：理解动态注入的工作原理

**立即尝试**：
1. 进行一次RimTalk对话
2. 打开预览器
3. 点击"读取上次输入 ??"
4. 查看神奇的效果！

---

**感谢使用 RimTalk-ExpandMemory！** ???

如有问题或建议，欢迎反馈！
