# ?? RimTalk-ExpandMemory v3.3.3 发布

## ? **新功能**

### **Pawn专属常识系统**

为常识库添加**专属殖民者**功能，让每个殖民者都有自己的私密知识！

---

## ?? **核心特性**

| 特性 | 描述 |
|------|------|
| ? **自动专属** | 系统自动生成的Pawn状态常识自动设置为专属 |
| ? **手动控制** | 用户可在UI界面选择全局或专属于特定殖民者 |
| ? **智能筛选** | 对话时自动只注入全局常识+该Pawn的专属常识 |
| ? **UI友好** | 下拉菜单选择，清晰显示可见范围 |

---

## ?? **功能详解**

### **1. 自动生成专属常识**

系统自动为每个殖民者生成的状态常识（如"Alice是新成员，3天前加入"）会**自动设置为专属**：

```
Alice对话时：
  ? 看到：Alice是新成员，3天前加入（专属）
  ? 看不到：Bob是狙击手（Bob专属）

Bob对话时：
  ? 看到：Bob是狙击手（专属）
  ? 看不到：Alice是新成员（Alice专属）
```

### **2. 手动设置专属常识**

编辑常识时，可以选择：

```
┌─────────────────────────────────┐
│ 编辑常识                        │
├─────────────────────────────────┤
│ 标签:       [角色背景]          │
│ 重要性:     [======>    ] 0.8   │
│ 专属殖民者: [点击选择 ]        │
│                                 │
│ 选项：                          │
│   - 全局可见（所有殖民者）      │
│   - 专属: Alice                 │
│   - 专属: Bob                   │
│   - 专属: Charlie               │
└─────────────────────────────────┘
```

### **3. 智能注入**

对话时，系统会智能筛选常识：

| 常识类型 | Alice对话 | Bob对话 | Charlie对话 |
|---------|----------|---------|------------|
| 边缘世界规则（全局） | ? | ? | ? |
| Alice是新成员（专属Alice） | ? | ? | ? |
| Bob是狙击手（专属Bob） | ? | ? | ? |
| Charlie的秘密（专属Charlie） | ? | ? | ? |

---

## ?? **Bug修复**

### **事件时间筛选逻辑修复**

**问题**：事件记录常识的时间计算错误，导致：
- ? 记录的是游戏开始时的古老事件
- ? 时间前缀不准确（显示"3天前"实际是10天前）

**修复**：
```csharp
// 修复前（错误）
e.Age >= (currentTick - 1hour)  // 筛选出1小时前的事件

// 修复后（正确）
(currentTick - e.Age) <= 1hour  // 筛选出最近1小时内的事件
```

**影响**：
- ? 事件常识现在只记录**最近1小时**的事件
- ? 时间描述准确（"今天"、"3天前"等）
- ? 不会再出现古老事件

---

## ?? **使用场景**

### **场景1: 角色专属背景故事**

```
为刺客角色添加专属常识：
[角色背景|0.9] 你曾是帝国情报部门的特工，擅长潜行和暗杀
专属殖民者: Shadow（刺客）

效果：只有Shadow对话时会看到这条背景
```

### **场景2: 种族专属知识**

```
为龙王种角色添加：
[种族|0.9] 你是龙王种索拉克亚种，拥有强大的魔法能力但惧怕寒冷
专属殖民者: Draco（龙王种）

效果：只有Draco知道自己的种族特性
```

### **场景3: 新成员引导**

```
系统自动生成（无需手动）：
[殖民地成员|0.5] Rookie是殖民地的新成员，今天加入，对殖民地历史尚不熟悉
专属殖民者: Rookie（自动设置）

效果：
- Rookie对话时会提到自己是新人
- 老成员不会看到这条常识
```

---

## ?? **技术实现**

### **数据结构**

```csharp
public class CommonKnowledgeEntry
{
    public int targetPawnId = -1;  // -1=全局，>=0=专属Pawn ID
}
```

### **自动设置（Pawn状态常识）**

```csharp
// PawnStatusKnowledgeGenerator.cs - 自动生成的常识
var newEntry = new CommonKnowledgeEntry(statusTag, newContent)
{
    targetPawnId = pawn.thingIDNumber  // ? 自动设置专属
};
```

### **智能筛选（常识注入）**

```csharp
// CommonKnowledgeLibrary.cs - InjectKnowledgeWithDetails()
var filteredEntries = entries
    .Where(e => e.isEnabled)
    .Where(e => e.targetPawnId == -1 ||  // 全局常识
               (currentPawn != null && 
                e.targetPawnId == currentPawn.thingIDNumber))  // 专属常识
    .ToList();
```

---

## ?? **完整文档**

详细使用指南请查看：
- **`PAWN_SPECIFIC_KNOWLEDGE_v3.3.3.md`** - 完整功能文档（288行）

---

## ?? **兼容性**

- ? **完全向后兼容** - 旧存档中的常识默认为全局（`targetPawnId = -1`）
- ? **无破坏性更改** - 现有功能完全保留
- ? **存档安全** - 可以安全升级

---

## ?? **安装/更新**

1. **关闭RimWorld**
2. **备份存档**（可选但推荐）
3. **运行部署脚本**：`deploy-v3.3.2.3.bat`
4. **启动RimWorld**并加载存档

或手动安装：
1. 复制 `bin_deploy/RimTalkMemoryPatch.dll` 到Mod目录
2. 复制 `Defs/` 和 `About/` 文件夹

---

## ?? **快速测试**

启动游戏后：

### **测试1: 查看自动生成的专属常识**

1. 打开**常识库管理**
2. 点击**自动生成** → **立即生成Pawn状态常识**
3. 查看生成的常识，应该显示：
   ```
   可见范围: 专属: Alice
   可见范围: 专属: Bob
   ```

### **测试2: 手动创建专属常识**

1. 点击**新建常识**
2. 填写标签、内容
3. 点击**专属殖民者**下拉菜单
4. 选择特定殖民者或"全局可见"
5. 保存

### **测试3: 验证注入效果**

1. 打开**注入预览器**
2. 选择不同的Pawn
3. 观察注入的常识是否正确筛选

---

## ?? **注意事项**

### **1. Pawn删除后**

如果专属的Pawn被删除（死亡/离开）：
- 常识仍然存在
- 显示为：`专属: Pawn已删除 (ID:123)`
- 不会被任何Pawn看到

**建议**：定期清理无效专属常识或改为全局

### **2. 性能影响**

- 筛选操作时间复杂度：O(n)
- 对于<1000条常识，性能影响可忽略
- 推荐定期清理无用常识

---

## ?? **未来计划 (v3.3.4)**

- [ ] **批量设置** - 一键将状态常识设为专属
- [ ] **标签筛选** - 按专属/全局快速筛选
- [ ] **自动清理** - 检测并清理无效专属常识
- [ ] **多Pawn专属** - 一条常识可专属于多个Pawn
- [ ] **阵营专属** - 专属于整个阵营

---

## ?? **反馈与支持**

- **GitHub Issues**: [报告Bug](https://github.com/sanguodxj-byte/RimTalk-ExpandMemory/issues)
- **Steam创意工坊**: 评论区反馈
- **Discord**: 加入社区讨论

---

## ?? **致谢**

感谢所有测试者和反馈Bug的玩家！

特别感谢提出"专属常识"需求的用户。

---

## ?? **更新日志**

### v3.3.3 (2025-05-XX)

**新增功能**：
- ? Pawn专属常识系统
- ? UI下拉菜单选择器
- ? 自动生成的状态常识专属化
- ? 详情面板显示可见范围

**Bug修复**：
- ? 修复事件时间筛选逻辑错误
- ? 修复时间前缀不准确问题

**文档**：
- ? 新增完整功能文档（288行）
- ? 新增使用场景和示例

**技术改进**：
- ? 常识注入智能筛选
- ? 零破坏性更改
- ? 完全向后兼容

---

**v3.3.3 - Pawn-Specific Knowledge System** ??  
**让每个殖民者都有自己的秘密！**
